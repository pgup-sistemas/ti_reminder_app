<!DOCTYPE html>
<html class="writer-html5" lang="pt_BR" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="O√©zios Normando - Equipe TI OSN" /><link rel="canonical" href="http://192.168.1.86:5000/docs/dev-guide/security-implementation/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Implementa√ß√£o de Seguran√ßa - TI OSN System - Documenta√ß√£o Oficial</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
        <link href="../../stylesheets/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Implementa\u00e7\u00e3o de Seguran\u00e7a";
        var mkdocs_page_input_path = "dev-guide\\security-implementation.md";
        var mkdocs_page_url = "/docs/dev-guide/security-implementation/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> TI OSN System - Documenta√ß√£o Oficial
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Buscar documentos" aria-label="Buscar documentos" title="Digite o termo a ser buscado aqui" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Menu de navega√ß√£o">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">In√≠cio</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../apresentacao/">Apresenta√ß√£o do Sistema</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../RESUMO_EXECUTIVO/">Resumo Executivo</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Guia do Usu√°rio</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/overview/">Vis√£o Geral</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/security/">Seguran√ßa</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/tasks/">Atividades & Projetos</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/reminders/">Notifica√ß√µes Programadas</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/chamados/">Tickets & Suporte</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/equipment/">Gest√£o de Ativos</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/tutorials/">Base de Conhecimento</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/equipment/">Equipamentos</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/dashboard/">Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/rfid/">Sistema RFID</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/satisfaction/">Avalia√ß√£o de Satisfa√ß√£o</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/certifications/">Certifica√ß√µes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guia do Administrador</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin-guide/security-admin/">Gerenciamento de Seguran√ßa</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin-guide/equipment-admin/">Equipamentos</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin-guide/performance-admin/">Performance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin-guide/rfid-admin/">RFID</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin-guide/satisfaction-admin/">Satisfa√ß√£o</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin-guide/certifications-admin/">Certifica√ß√µes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guia do Desenvolvedor</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Implementa√ß√£o de Seguran√ßa</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#visao-geral-tecnica">Vis√£o Geral T√©cnica</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#score-de-seguranca">üìä Score de Seguran√ßa</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#arquitetura-de-seguranca">üèóÔ∏è Arquitetura de Seguran√ßa</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#stack-tecnologico">Stack Tecnol√≥gico</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#camadas-de-protecao">Camadas de Prote√ß√£o</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sistema-de-autenticacao">üîë Sistema de Autentica√ß√£o</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#flask-login-puro">Flask-Login Puro</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#modelo-user">Modelo User</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rota-de-login">Rota de Login</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#validacao-de-senha-forte">üõ°Ô∏è Valida√ß√£o de Senha Forte</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#validador-custom">Validador Custom</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#uso-nos-formularios">Uso nos Formul√°rios</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rate-limiting">‚è±Ô∏è Rate Limiting</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#configuracao">Configura√ß√£o</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#aplicacao-nas-rotas">Aplica√ß√£o nas Rotas</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#logging-de-seguranca">üìù Logging de Seguran√ßa</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#configuracao_1">Configura√ß√£o</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#eventos-auditados">Eventos Auditados</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#headers-de-seguranca-http">üõ°Ô∏è Headers de Seguran√ßa HTTP</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#talisman-configuration">Talisman Configuration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#headers-aplicados">Headers Aplicados</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sessoes-seguras">üîí Sess√µes Seguras</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#configuracao_2">Configura√ß√£o</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#decoradores-de-autorizacao">üîê Decoradores de Autoriza√ß√£o</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#implementacao">Implementa√ß√£o</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#uso">Uso</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#migracao-do-banco">üìä Migra√ß√£o do Banco</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#script-de-migracao">Script de Migra√ß√£o</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#aplicar">Aplicar</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#testes-de-seguranca">üß™ Testes de Seguran√ßa</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#testar-senha-forte">Testar Senha Forte</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#testar-bloqueio-de-conta">Testar Bloqueio de Conta</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#testar-rate-limiting">Testar Rate Limiting</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#monitoramento">üîç Monitoramento</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#queries-uteis">Queries √öteis</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#analise-de-logs">An√°lise de Logs</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#referencias">üìö Refer√™ncias</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#documentos-do-projeto">Documentos do Projeto</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#padroes-e-frameworks">Padr√µes e Frameworks</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Menu de navega√ß√£o em dispositivo m√≥vel">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">TI OSN System - Documenta√ß√£o Oficial</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Documentos"></a></li>
          <li class="breadcrumb-item">Guia do Desenvolvedor</li>
      <li class="breadcrumb-item active">Implementa√ß√£o de Seguran√ßa</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="implementacao-de-seguranca-guia-do-desenvolvedor">üîê Implementa√ß√£o de Seguran√ßa - Guia do Desenvolvedor<a class="headerlink" href="#implementacao-de-seguranca-guia-do-desenvolvedor" title="Permanent link">&para;</a></h1>
<h2 id="visao-geral-tecnica">Vis√£o Geral T√©cnica<a class="headerlink" href="#visao-geral-tecnica" title="Permanent link">&para;</a></h2>
<p>Documenta√ß√£o completa das implementa√ß√µes de seguran√ßa do TI OSN System v2.0, incluindo arquitetura, c√≥digo e boas pr√°ticas.</p>
<hr />
<h2 id="score-de-seguranca">üìä Score de Seguran√ßa<a class="headerlink" href="#score-de-seguranca" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Categoria</th>
<th>Score</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Autentica√ß√£o</strong></td>
<td>10/10</td>
<td>‚úÖ Excelente</td>
</tr>
<tr>
<td><strong>Autoriza√ß√£o</strong></td>
<td>9/10</td>
<td>‚úÖ Muito Bom</td>
</tr>
<tr>
<td><strong>Valida√ß√£o de Dados</strong></td>
<td>10/10</td>
<td>‚úÖ Excelente</td>
</tr>
<tr>
<td><strong>Prote√ß√£o CSRF</strong></td>
<td>10/10</td>
<td>‚úÖ Excelente</td>
</tr>
<tr>
<td><strong>Headers HTTP</strong></td>
<td>9/10</td>
<td>‚úÖ Muito Bom</td>
</tr>
<tr>
<td><strong>Logging</strong></td>
<td>10/10</td>
<td>‚úÖ Excelente</td>
</tr>
<tr>
<td><strong>Rate Limiting</strong></td>
<td>10/10</td>
<td>‚úÖ Excelente</td>
</tr>
<tr>
<td><strong>Sess√µes</strong></td>
<td>9/10</td>
<td>‚úÖ Muito Bom</td>
</tr>
<tr>
<td><strong>OWASP Top 10</strong></td>
<td>9.3/10</td>
<td>‚úÖ Excelente</td>
</tr>
</tbody>
</table>
<p><strong>Score Geral: 9.3/10</strong> üèÜ</p>
<hr />
<h2 id="arquitetura-de-seguranca">üèóÔ∏è Arquitetura de Seguran√ßa<a class="headerlink" href="#arquitetura-de-seguranca" title="Permanent link">&para;</a></h2>
<h3 id="stack-tecnologico">Stack Tecnol√≥gico<a class="headerlink" href="#stack-tecnologico" title="Permanent link">&para;</a></h3>
<pre><code class="language-python"># Depend√™ncias de Seguran√ßa
Flask==2.2.5
Flask-Login==0.6.3          # Gerenciamento de sess√µes
Flask-WTF==1.2.2            # Prote√ß√£o CSRF
Flask-Limiter==4.0.0        # Rate limiting
Flask-Talisman==1.1.0       # Headers HTTP seguros
Werkzeug==3.1.3             # Hashing de senhas (PBKDF2)
</code></pre>
<h3 id="camadas-de-protecao">Camadas de Prote√ß√£o<a class="headerlink" href="#camadas-de-protecao" title="Permanent link">&para;</a></h3>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   1. Headers HTTP (Talisman)       ‚îÇ ‚Üê HSTS, CSP, X-Frame-Options
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   2. Rate Limiting                  ‚îÇ ‚Üê 5 req/min (login)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   3. CSRF Protection (WTF)          ‚îÇ ‚Üê Tokens em formul√°rios
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   4. Autentica√ß√£o (Flask-Login)     ‚îÇ ‚Üê Sess√µes seguras
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   5. Valida√ß√£o (Custom)             ‚îÇ ‚Üê Senha forte, username
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   6. Bloqueio de Conta              ‚îÇ ‚Üê 5 tentativas = 15min
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   7. Logging de Seguran√ßa           ‚îÇ ‚Üê Auditoria completa
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre>
<hr />
<h2 id="sistema-de-autenticacao">üîë Sistema de Autentica√ß√£o<a class="headerlink" href="#sistema-de-autenticacao" title="Permanent link">&para;</a></h2>
<h3 id="flask-login-puro">Flask-Login Puro<a class="headerlink" href="#flask-login-puro" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>app/__init__.py</code></p>
<pre><code class="language-python">from flask_login import LoginManager

login_manager = LoginManager()
login_manager.login_view = 'auth.login'
login_manager.login_message = 'Por favor, fa√ßa login.'
login_manager.login_message_category = 'info'

@login_manager.user_loader
def load_user(user_id):
    from .models import User
    return User.query.get(int(user_id))
</code></pre>
<h3 id="modelo-user">Modelo User<a class="headerlink" href="#modelo-user" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>app/models.py</code></p>
<pre><code class="language-python">class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(64), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(256), nullable=False)

    # Campos de auditoria
    login_attempts = db.Column(db.Integer, default=0, nullable=False)
    locked_until = db.Column(db.DateTime, nullable=True)
    password_changed_at = db.Column(db.DateTime, nullable=True)
    last_failed_login = db.Column(db.DateTime, nullable=True)
    last_password_reset = db.Column(db.DateTime, nullable=True)
    last_login = db.Column(db.DateTime, nullable=True)
    created_at = db.Column(db.DateTime, default=get_current_time_for_db)
    updated_at = db.Column(db.DateTime, onupdate=get_current_time_for_db)

    def set_password(self, password):
        &quot;&quot;&quot;Hash de senha com Werkzeug (PBKDF2)&quot;&quot;&quot;
        self.password_hash = generate_password_hash(password)
        self.password_changed_at = datetime.utcnow()

    def check_password(self, password):
        &quot;&quot;&quot;Verifica√ß√£o de senha&quot;&quot;&quot;
        return check_password_hash(self.password_hash, password)

    @property
    def is_active(self):
        &quot;&quot;&quot;Verifica se usu√°rio est√° ativo&quot;&quot;&quot;
        return self.ativo
</code></pre>
<h3 id="rota-de-login">Rota de Login<a class="headerlink" href="#rota-de-login" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>app/auth.py</code></p>
<pre><code class="language-python">@bp_auth.route(&quot;/login&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;])
@limiter.limit(&quot;5 per minute&quot;)
def login():
    if current_user.is_authenticated:
        return redirect(url_for(&quot;main.index&quot;))

    form = LoginForm()
    if form.validate_on_submit():
        user = User.query.filter_by(username=form.username.data).first()

        # 1. Verificar exist√™ncia
        if not user:
            security_logger.warning(
                f&quot;Tentativa com usu√°rio inexistente: {form.username.data} | &quot;
                f&quot;IP: {request.remote_addr}&quot;
            )
            flash_error(&quot;Usu√°rio ou senha inv√°lidos.&quot;)
            return render_template(&quot;login.html&quot;, form=form)

        # 2. Verificar conta ativa
        if not user.ativo:
            security_logger.warning(
                f&quot;Tentativa em conta desativada: {user.username}&quot;
            )
            flash_error(&quot;Conta desativada.&quot;)
            return render_template(&quot;login.html&quot;, form=form)

        # 3. Verificar bloqueio
        if user.locked_until and user.locked_until &gt; datetime.utcnow():
            minutes_left = int((user.locked_until - datetime.utcnow()).total_seconds() / 60)
            flash_error(f&quot;Conta bloqueada. Tente em {minutes_left} minutos.&quot;)
            return render_template(&quot;login.html&quot;, form=form)

        # 4. Verificar senha
        if user.check_password(form.password.data):
            # Sucesso
            user.last_login = get_current_time_for_db()
            user.login_attempts = 0
            user.locked_until = None
            db.session.commit()

            login_user(user, remember=form.remember_me.data)
            security_logger.info(f&quot;Login: {user.username} | IP: {request.remote_addr}&quot;)

            return redirect(url_for(&quot;main.index&quot;))
        else:
            # Falha - incrementar tentativas
            user.login_attempts = (user.login_attempts or 0) + 1

            if user.login_attempts &gt;= 5:
                user.locked_until = datetime.utcnow() + timedelta(minutes=15)
                security_logger.warning(f&quot;Conta bloqueada: {user.username}&quot;)
                flash_error(&quot;Conta bloqueada por 15 minutos.&quot;)
            else:
                remaining = 5 - user.login_attempts
                flash_error(f&quot;Senha inv√°lida. {remaining} tentativas restantes.&quot;)

            db.session.commit()

    return render_template(&quot;login.html&quot;, form=form)
</code></pre>
<hr />
<h2 id="validacao-de-senha-forte">üõ°Ô∏è Valida√ß√£o de Senha Forte<a class="headerlink" href="#validacao-de-senha-forte" title="Permanent link">&para;</a></h2>
<h3 id="validador-custom">Validador Custom<a class="headerlink" href="#validador-custom" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>app/validators.py</code></p>
<pre><code class="language-python">import re
from wtforms.validators import ValidationError

class StrongPassword:
    &quot;&quot;&quot;Validador de senha forte&quot;&quot;&quot;

    def __init__(self, message=None):
        self.message = message or (
            'Senha deve ter 8+ chars, 1 mai√∫scula, 1 min√∫scula, '
            '1 n√∫mero e 1 caractere especial'
        )

    def __call__(self, form, field):
        password = field.data

        if len(password) &lt; 8:
            raise ValidationError('M√≠nimo 8 caracteres.')

        if not re.search(r'[A-Z]', password):
            raise ValidationError('Falta letra mai√∫scula.')

        if not re.search(r'[a-z]', password):
            raise ValidationError('Falta letra min√∫scula.')

        if not re.search(r'\d', password):
            raise ValidationError('Falta n√∫mero.')

        if not re.search(r'[!@#$%^&amp;*(),.?&quot;:{}|&lt;&gt;]', password):
            raise ValidationError('Falta caractere especial.')


class NoCommonPassword:
    &quot;&quot;&quot;Bloqueia senhas comuns&quot;&quot;&quot;

    COMMON_PASSWORDS = [
        'password', 'password123', '12345678', 'qwerty',
        'Admin123', 'Senha123', 'Teste123'
        # ... lista completa
    ]

    def __call__(self, form, field):
        if field.data.lower() in [p.lower() for p in self.COMMON_PASSWORDS]:
            raise ValidationError('Senha muito comum. Use outra.')
</code></pre>
<h3 id="uso-nos-formularios">Uso nos Formul√°rios<a class="headerlink" href="#uso-nos-formularios" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>app/forms_auth.py</code></p>
<pre><code class="language-python">from .validators import StrongPassword, NoCommonPassword

class RegistrationForm(FlaskForm):
    password = PasswordField(
        &quot;Senha&quot;, 
        validators=[
            DataRequired(),
            StrongPassword(),
            NoCommonPassword()
        ]
    )
</code></pre>
<hr />
<h2 id="rate-limiting">‚è±Ô∏è Rate Limiting<a class="headerlink" href="#rate-limiting" title="Permanent link">&para;</a></h2>
<h3 id="configuracao">Configura√ß√£o<a class="headerlink" href="#configuracao" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>app/__init__.py</code></p>
<pre><code class="language-python">from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    key_func=get_remote_address,
    default_limits=[&quot;200 per day&quot;, &quot;50 per hour&quot;],
    storage_uri=&quot;memory://&quot;
)
</code></pre>
<h3 id="aplicacao-nas-rotas">Aplica√ß√£o nas Rotas<a class="headerlink" href="#aplicacao-nas-rotas" title="Permanent link">&para;</a></h3>
<pre><code class="language-python">@bp_auth.route(&quot;/login&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;])
@limiter.limit(&quot;5 per minute&quot;)
def login():
    # ...

@bp_auth.route(&quot;/register&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;])
@limiter.limit(&quot;3 per hour&quot;)
def register():
    # ...

@bp_auth.route(&quot;/reset_password_request&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;])
@limiter.limit(&quot;3 per hour&quot;)
def reset_password_request():
    # ...
</code></pre>
<hr />
<h2 id="logging-de-seguranca">üìù Logging de Seguran√ßa<a class="headerlink" href="#logging-de-seguranca" title="Permanent link">&para;</a></h2>
<h3 id="configuracao_1">Configura√ß√£o<a class="headerlink" href="#configuracao_1" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>config.py</code></p>
<pre><code class="language-python">LOGGING_CONFIG = {
    'version': 1,
    'formatters': {
        'security': {
            'format': '%(asctime)s - SECURITY - %(levelname)s - %(message)s',
        },
    },
    'handlers': {
        'security_file': {
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': 'logs/security.log',
            'maxBytes': 10485760,  # 10MB
            'backupCount': 10,
            'formatter': 'security',
        },
    },
    'loggers': {
        'security': {
            'handlers': ['security_file', 'console'],
            'level': 'INFO',
        },
    },
}
</code></pre>
<h3 id="eventos-auditados">Eventos Auditados<a class="headerlink" href="#eventos-auditados" title="Permanent link">&para;</a></h3>
<pre><code class="language-python">import logging
security_logger = logging.getLogger('security')

# 1. Login bem-sucedido
security_logger.info(
    f&quot;Login bem-sucedido: {user.username} (ID: {user.id}) | &quot;
    f&quot;IP: {request.remote_addr} | User-Agent: {request.headers.get('User-Agent')}&quot;
)

# 2. Login falho
security_logger.warning(
    f&quot;Tentativa falha: {user.username} | &quot;
    f&quot;Tentativa {user.login_attempts}/5 | IP: {request.remote_addr}&quot;
)

# 3. Conta bloqueada
security_logger.warning(
    f&quot;Conta bloqueada: {user.username} | &quot;
    f&quot;Tentativas: {user.login_attempts} | IP: {request.remote_addr}&quot;
)

# 4. Registro de usu√°rio
security_logger.info(
    f&quot;Novo usu√°rio: {user.username} (email: {user.email}) | &quot;
    f&quot;IP: {request.remote_addr}&quot;
)

# 5. Reset de senha solicitado
security_logger.info(
    f&quot;Reset solicitado: {user.username} | IP: {request.remote_addr}&quot;
)

# 6. Senha redefinida
security_logger.info(
    f&quot;Senha redefinida: {user.username} | IP: {request.remote_addr}&quot;
)

# 7. Token inv√°lido
security_logger.warning(
    f&quot;Token inv√°lido: {token[:20]}... | IP: {request.remote_addr}&quot;
)

# 8. Logout
security_logger.info(
    f&quot;Logout: {user.username} | IP: {request.remote_addr}&quot;
)
</code></pre>
<hr />
<h2 id="headers-de-seguranca-http">üõ°Ô∏è Headers de Seguran√ßa HTTP<a class="headerlink" href="#headers-de-seguranca-http" title="Permanent link">&para;</a></h2>
<h3 id="talisman-configuration">Talisman Configuration<a class="headerlink" href="#talisman-configuration" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>app/__init__.py</code></p>
<pre><code class="language-python">from flask_talisman import Talisman

talisman = Talisman()

# Configura√ß√£o no create_app()
if not app.config.get('TESTING'):
    csp = {
        'default-src': &quot;'self'&quot;,
        'script-src': [
            &quot;'self'&quot;,
            &quot;'unsafe-inline'&quot;,  # Bootstrap
            'cdn.jsdelivr.net',
            'code.jquery.com'
        ],
        'style-src': [
            &quot;'self'&quot;,
            &quot;'unsafe-inline'&quot;,
            'cdn.jsdelivr.net',
            'fonts.googleapis.com'
        ],
        'font-src': [
            &quot;'self'&quot;,
            'fonts.gstatic.com',
            'data:'
        ],
        'img-src': [&quot;'self'&quot;, 'data:', 'https:'],
        'frame-ancestors': &quot;'none'&quot;,
    }

    talisman.init_app(
        app,
        force_https=app.config.get('SESSION_COOKIE_SECURE'),
        strict_transport_security=True,
        strict_transport_security_max_age=31536000,  # 1 ano
        content_security_policy=csp,
        referrer_policy='strict-origin-when-cross-origin',
    )
</code></pre>
<h3 id="headers-aplicados">Headers Aplicados<a class="headerlink" href="#headers-aplicados" title="Permanent link">&para;</a></h3>
<pre><code class="language-http">Strict-Transport-Security: max-age=31536000; includeSubDomains
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
Referrer-Policy: strict-origin-when-cross-origin
</code></pre>
<hr />
<h2 id="sessoes-seguras">üîí Sess√µes Seguras<a class="headerlink" href="#sessoes-seguras" title="Permanent link">&para;</a></h2>
<h3 id="configuracao_2">Configura√ß√£o<a class="headerlink" href="#configuracao_2" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>config.py</code></p>
<pre><code class="language-python"># Desenvolvimento
SESSION_COOKIE_SECURE = False  # HTTP permitido
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = 'Lax'
PERMANENT_SESSION_LIFETIME = timedelta(hours=24)

# Produ√ß√£o
class ProductionConfig(Config):
    SESSION_COOKIE_SECURE = True  # HTTPS obrigat√≥rio
    SESSION_COOKIE_SAMESITE = 'Strict'
</code></pre>
<hr />
<h2 id="decoradores-de-autorizacao">üîê Decoradores de Autoriza√ß√£o<a class="headerlink" href="#decoradores-de-autorizacao" title="Permanent link">&para;</a></h2>
<h3 id="implementacao">Implementa√ß√£o<a class="headerlink" href="#implementacao" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>app/auth_utils.py</code></p>
<pre><code class="language-python">from functools import wraps
from flask import redirect, url_for
from flask_login import current_user

def login_required(f):
    &quot;&quot;&quot;Requer autentica√ß√£o&quot;&quot;&quot;
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not current_user.is_authenticated:
            flash_error(&quot;Login necess√°rio.&quot;)
            return redirect(url_for(&quot;auth.login&quot;))

        if not current_user.ativo:
            flash_error(&quot;Conta desativada.&quot;)
            logout_user()
            return redirect(url_for(&quot;auth.login&quot;))

        return f(*args, **kwargs)
    return decorated_function


def admin_required(f):
    &quot;&quot;&quot;Requer admin&quot;&quot;&quot;
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not current_user.is_authenticated:
            return redirect(url_for(&quot;auth.login&quot;))

        if not current_user.is_admin:
            flash_error(&quot;Acesso restrito a admin.&quot;)
            return redirect(url_for(&quot;main.index&quot;))

        return f(*args, **kwargs)
    return decorated_function


def ti_required(f):
    &quot;&quot;&quot;Requer TI ou admin&quot;&quot;&quot;
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not current_user.is_authenticated:
            return redirect(url_for(&quot;auth.login&quot;))

        if not (current_user.is_ti or current_user.is_admin):
            flash_error(&quot;Acesso restrito a TI.&quot;)
            return redirect(url_for(&quot;main.index&quot;))

        return f(*args, **kwargs)
    return decorated_function
</code></pre>
<h3 id="uso">Uso<a class="headerlink" href="#uso" title="Permanent link">&para;</a></h3>
<pre><code class="language-python">from app.auth_utils import login_required, admin_required, ti_required

@app.route('/dashboard')
@login_required
def dashboard():
    # Qualquer usu√°rio autenticado

@app.route('/admin/users')
@admin_required
def admin_users():
    # Apenas administradores

@app.route('/equipment/manage')
@ti_required
def manage_equipment():
    # TI ou administradores
</code></pre>
<hr />
<h2 id="migracao-do-banco">üìä Migra√ß√£o do Banco<a class="headerlink" href="#migracao-do-banco" title="Permanent link">&para;</a></h2>
<h3 id="script-de-migracao">Script de Migra√ß√£o<a class="headerlink" href="#script-de-migracao" title="Permanent link">&para;</a></h3>
<p><strong>Arquivo:</strong> <code>migrations/versions/add_security_fields_to_user.py</code></p>
<pre><code class="language-python">def upgrade():
    &quot;&quot;&quot;Adiciona campos de seguran√ßa&quot;&quot;&quot;
    op.add_column('user', sa.Column('login_attempts', sa.Integer(), 
                  nullable=False, server_default='0'))
    op.add_column('user', sa.Column('locked_until', sa.DateTime(), 
                  nullable=True))
    op.add_column('user', sa.Column('password_changed_at', sa.DateTime(), 
                  nullable=True))
    op.add_column('user', sa.Column('last_failed_login', sa.DateTime(), 
                  nullable=True))
    op.add_column('user', sa.Column('last_password_reset', sa.DateTime(), 
                  nullable=True))


def downgrade():
    &quot;&quot;&quot;Remove campos de seguran√ßa&quot;&quot;&quot;
    op.drop_column('user', 'last_password_reset')
    op.drop_column('user', 'last_failed_login')
    op.drop_column('user', 'password_changed_at')
    op.drop_column('user', 'locked_until')
    op.drop_column('user', 'login_attempts')
</code></pre>
<h3 id="aplicar">Aplicar<a class="headerlink" href="#aplicar" title="Permanent link">&para;</a></h3>
<pre><code class="language-bash">flask db upgrade
</code></pre>
<hr />
<h2 id="testes-de-seguranca">üß™ Testes de Seguran√ßa<a class="headerlink" href="#testes-de-seguranca" title="Permanent link">&para;</a></h2>
<h3 id="testar-senha-forte">Testar Senha Forte<a class="headerlink" href="#testar-senha-forte" title="Permanent link">&para;</a></h3>
<pre><code class="language-python">def test_strong_password():
    # Senha fraca - deve falhar
    with pytest.raises(ValidationError):
        validator = StrongPassword()
        validator(form, Field('senha123'))

    # Senha forte - deve passar
    validator(form, Field('S3nh@Fort3!'))
</code></pre>
<h3 id="testar-bloqueio-de-conta">Testar Bloqueio de Conta<a class="headerlink" href="#testar-bloqueio-de-conta" title="Permanent link">&para;</a></h3>
<pre><code class="language-python">def test_account_lockout(client):
    # 5 tentativas falhas
    for i in range(5):
        response = client.post('/auth/login', data={
            'username': 'test_user',
            'password': 'wrong_password'
        })

    # 6¬™ tentativa - deve estar bloqueado
    response = client.post('/auth/login', data={
        'username': 'test_user',
        'password': 'correct_password'
    })
    assert b'bloqueada' in response.data
</code></pre>
<h3 id="testar-rate-limiting">Testar Rate Limiting<a class="headerlink" href="#testar-rate-limiting" title="Permanent link">&para;</a></h3>
<pre><code class="language-python">def test_rate_limit(client):
    # 6 requisi√ß√µes em sequ√™ncia
    for i in range(6):
        response = client.post('/auth/login', data={
            'username': 'test',
            'password': 'test'
        })

    # 6¬™ requisi√ß√£o deve ser bloqueada
    assert response.status_code == 429
</code></pre>
<hr />
<h2 id="monitoramento">üîç Monitoramento<a class="headerlink" href="#monitoramento" title="Permanent link">&para;</a></h2>
<h3 id="queries-uteis">Queries √öteis<a class="headerlink" href="#queries-uteis" title="Permanent link">&para;</a></h3>
<pre><code class="language-sql">-- Contas bloqueadas
SELECT username, locked_until, login_attempts
FROM user
WHERE locked_until &gt; NOW()
ORDER BY locked_until DESC;

-- Tentativas de login recentes
SELECT username, login_attempts, last_failed_login
FROM user
WHERE login_attempts &gt; 0
ORDER BY last_failed_login DESC
LIMIT 10;

-- Senhas n√£o alteradas h√° mais de 6 meses
SELECT username, email, password_changed_at
FROM user
WHERE password_changed_at &lt; NOW() - INTERVAL '6 months'
OR password_changed_at IS NULL;
</code></pre>
<h3 id="analise-de-logs">An√°lise de Logs<a class="headerlink" href="#analise-de-logs" title="Permanent link">&para;</a></h3>
<pre><code class="language-bash"># Logins falhos nas √∫ltimas 24h
grep &quot;Tentativa falha&quot; logs/security.log | grep &quot;$(date +%Y-%m-%d)&quot;

# IPs com mais tentativas
grep &quot;Tentativa falha&quot; logs/security.log | grep -oP &quot;IP: \K[0-9.]+&quot; | sort | uniq -c | sort -rn

# Contas bloqueadas hoje
grep &quot;Conta bloqueada&quot; logs/security.log | grep &quot;$(date +%Y-%m-%d)&quot;
</code></pre>
<hr />
<h2 id="referencias">üìö Refer√™ncias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<h3 id="documentos-do-projeto">Documentos do Projeto<a class="headerlink" href="#documentos-do-projeto" title="Permanent link">&para;</a></h3>
<ul>
<li><code>SECURITY_GUIDE.md</code> - Guia completo de seguran√ßa</li>
<li><code>SECURITY_IMPROVEMENTS.md</code> - Changelog de melhorias</li>
<li><code>IMPLEMENTATION_REPORT.md</code> - Relat√≥rio de implementa√ß√£o</li>
<li><code>.env.example</code> - Template de configura√ß√£o</li>
</ul>
<h3 id="padroes-e-frameworks">Padr√µes e Frameworks<a class="headerlink" href="#padroes-e-frameworks" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://owasp.org/www-project-top-ten/">OWASP Top 10</a></li>
<li><a href="https://flask.palletsprojects.com/en/latest/security/">Flask Security</a></li>
<li><a href="https://pages.nist.gov/800-63-3/">NIST Password Guidelines</a></li>
<li><a href="https://cwe.mitre.org/top25/">CWE Top 25</a></li>
</ul>
<hr />
<p><strong>√öltima atualiza√ß√£o:</strong> Janeiro 2025<br />
<strong>Vers√£o:</strong> 2.0 - Seguran√ßa Enterprise<br />
<strong>Desenvolvido por:</strong> Equipe TI OSN</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Navega√ß√£o no rodap√©">
        <a href="../../admin-guide/certifications-admin/" class="btn btn-neutral float-left" title="Certifica√ß√µes"><span class="icon icon-circle-arrow-left"></span> Anterior</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Constru√≠do com <a href="https://www.mkdocs.org/">MkDocs</a> usando <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provido por <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Vers√µes">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../admin-guide/certifications-admin/" style="color: #fcfcfc">&laquo; Anterior</a></span>
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../javascripts/extra.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>

{% extends 'base.html' %}
{% block title %}Gestão de Lembretes | TI reminder {% endblock %}

<script>
  function renderStatus(reminder) {
    if(reminder.completed) {
        return '<span class="badge bg-success d-flex align-items-center gap-1"><i class="fas fa-check-circle"></i> Concluído</span>';
    } else if(reminder.status === 'ok') {
        return '<span class="badge bg-primary d-flex align-items-center gap-1"><i class="fas fa-check"></i> Ok</span>';
    } else if(reminder.status === 'alert') {
        return '<span class="badge bg-warning text-dark d-flex align-items-center gap-1"><i class="fas fa-calendar-day"></i> Em breve</span>';
    } else if(reminder.status === 'expired') {
        return '<span class="badge bg-danger d-flex align-items-center gap-1"><i class="fas fa-exclamation-circle"></i> Vencido</span>';
    }
    return '<span class="badge bg-secondary d-flex align-items-center gap-1"><i class="fas fa-clock"></i> Pendente</span>';
}

  function renderActions(reminder) {
    let actions = `<div class='d-flex gap-1'>`;
    actions += `<a href="/reminders/edit/${reminder.id}" class="btn btn-sm btn-warning" title="Editar"><i class="fas fa-edit"> </i></a>`;
    if (!reminder.completed) {
        actions += `<form method="POST" action="/reminders/complete/${reminder.id}" class="d-inline"><button type="submit"class="btn btn-sm btn-success"title="Finalizar"><i class="fas fa-check"> </i></button></form>`;
    }
    actions += `<form method="POST" action="/reminders/delete/${reminder.id}" class="d-inline"><button type="submit"class="btn btn-sm btn-danger"onclick="return confirm('Excluir este lembrete?');"title="Excluir"><i class="fas fa-trash-alt"></i></button></form>`;
    actions += `</div>`;
    return actions;
}

  function updateRemindersTable() {
      fetch('/reminders/json')
        .then(response => response.json())
        .then(data => {
          const reminders = data.reminders;
          const tbody = document.querySelector('table.table tbody');
          if (!tbody) return;
          if (reminders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7">Nenhum lembrete cadastrado.</td></tr>';
            return;
          }
          tbody.innerHTML = reminders.map(reminder => `
            <tr class="${reminder.completed ? 'table-success' : ''}">
              <td>${reminder.name}</td>
              <td>${reminder.type}</td>
              <td>${reminder.due_date}</td>
              <td>${reminder.responsible}</td>
              <td>${reminder.frequency || ''}</td>
              <td>${reminder.sector || ''}</td>
              <td>${renderStatus(reminder)}</td>
              <td>${renderActions(reminder)}</td>
            </tr>
          `).join('');
        });
  }
  // Atualiza a cada 3 minutos (180000 ms)
  setInterval(updateRemindersTable, 180000);
  // Atualiza ao carregar a página também
  window.addEventListener('DOMContentLoaded', updateRemindersTable);
</script>

{% block content %}
<h1 class="mt-2 mb-3" style="padding-top:0.5rem;"><i class="fas fa-bell me-2"></i>Lembretes</h1>
<!-- Formulário de Cadastro/Edição de Lembretes -->
{% if edit_id %}
  <div class="alert alert-warning">Editando lembrete. <a href="{{ url_for('main.reminders') }}">Cancelar edição</a></div>
{% endif %}
<div class="card mb-3">
  <div class="card-body">
    <form method="POST">
      {{ form.hidden_tag() }}
      <div class="row">
        <div class="col-md-3 mb-2">
          {{ form.name.label }}{{ form.name(class_='form-control') }}
          {% for error in form.name.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
        </div>
        <div class="col-md-2 mb-2">
          {{ form.type.label }}{{ form.type(class_='form-control') }}
          {% for error in form.type.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
        </div>
        <div class="col-md-2 mb-2">
          {{ form.due_date.label }}{{ form.due_date(class_='form-control') }}
          {% for error in form.due_date.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
        </div>
        <div class="col-md-2 mb-2">
          {{ form.responsible.label }}{{ form.responsible(class_='form-control') }}
          {% for error in form.responsible.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
        </div>
        <div class="col-md-2 mb-2">
          {{ form.frequency.label }}{{ form.frequency(class_='form-select') }}
          {% for error in form.frequency.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
        </div>
        <div class="col-md-2 mb-2">
          {{ form.sector_id.label }}{{ form.sector_id(class_='form-select') }}
          {% for error in form.sector_id.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
          <small class="text-muted">Ou cadastre um novo setor abaixo</small>
          {{ form.new_sector(class_='form-control mt-1', placeholder='Novo setor') }}
        </div>
        <div class="col-md-1 mb-2 d-flex align-items-end">{{ form.submit(class_='btn btn-success w-100') }}</div>
      </div>
    </form>
  </div>
</div>
<div class="table-responsive" style="max-height: 400px;">
<table class="table table-bordered align-middle mb-0">
  <thead class="table-light">
    <tr>
      <th><i class="fas fa-clipboard-list"></i> Nome</th>
      <th><i class="fas fa-tag"></i> Tipo</th>
      <th><i class="fas fa-calendar-alt"></i> Vencimento</th>
      <th><i class="fas fa-user"></i> Responsável</th>
      <th><i class="fas fa-sync-alt"></i> Frequência</th>
      <th><i class="fas fa-sitemap"></i> Setor</th>
      <th><i class="fas fa-info-circle"></i> Status</th>
      <th><i class="fas fa-cogs"></i> Ações</th>
    </tr>
  </thead>
  <tbody>
    {% for reminder in reminders %}
    <tr class="{% if reminder.completed %}table-success{% endif %}">
      <td>{{ reminder.name }}</td>
      <td>{{ reminder.type }}</td>
      <td>{{ reminder.due_date }}</td>
      <td>{{ reminder.responsible }}</td>
      <td>{{ reminder.frequency }}</td>
      <td>{{ reminder.sector.name if reminder.sector else '' }}</td>
      <td>
        {% if reminder.completed %}
          <span class="badge bg-success d-flex align-items-center gap-1"><i class="fas fa-check-circle"></i> Concluído</span>
        {% elif reminder.status == 'ok' %}
          <span class="badge bg-primary d-flex align-items-center gap-1"><i class="fas fa-check"></i> Ok</span>
        {% elif reminder.status == 'alert' %}
          <span class="badge bg-warning text-dark d-flex align-items-center gap-1"><i class="fas fa-calendar-day"></i> Em breve</span>
        {% elif reminder.status == 'expired' %}
          <span class="badge bg-danger d-flex align-items-center gap-1"><i class="fas fa-exclamation-circle"></i> Vencido</span>
        {% else %}
          <span class="badge bg-secondary d-flex align-items-center gap-1"><i class="fas fa-clock"></i> Pendente</span>
        {% endif %}
      </td>
      <td class="text-nowrap">
  <div class="d-flex gap-1">
    <a href="{{ url_for('main.edit_reminder', id=reminder.id) }}" class="btn btn-sm btn-warning" title="Editar"><i class="fas fa-edit"></i></a>
{% if not reminder.completed %}
<form method="POST" action="{{ url_for('main.complete_reminder', id=reminder.id) }}" class="d-inline">
  <button type="submit" class="btn btn-sm btn-success" title="Finalizar"><i class="fas fa-check"></i></button>
</form>
{% endif %}
<form method="POST" action="{{ url_for('main.delete_reminder', id=reminder.id) }}" class="d-inline">
  <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Excluir este lembrete?');" title="Excluir"><i class="fas fa-trash-alt"></i></button>
</form>
  </div>
</td>
    </tr>
    {% else %}
    <tr><td colspan="8">Nenhum lembrete cadastrado.</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>
<script>
function renderStatus(reminder) {
    if(reminder.completed) {
        return '<span class="badge bg-primary"><i class="fas fa-check-circle"></i> Concluído</span>';
    } else if(reminder.status === 'ok') {
        return '<span class="badge bg-success"><i class="fas fa-check"></i> Ok</span>';
    } else if(reminder.status === 'alert') {
        return '<span class="badge bg-warning text-dark"><i class="fas fa-calendar-day"></i> Em breve</span>';
    } else if(reminder.status === 'expired') {
        return '<span class="badge bg-danger"><i class="fas fa-exclamation-circle"></i> Vencido</span>';
    }
    return '';
}

function renderActions(reminder) {
    let actions = `<a href="/reminders/edit/${reminder.id}" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i>Editar</a> `;
    if (!reminder.completed) {
        actions += `<form method="POST" action="/reminders/complete/${reminder.id}" style="display:inline;"><button type="submit" class="btn btn-sm btn-success"><i class="fas fa-check"></i>Finalizar</button></form> `;
    }
    actions += `<form method="POST" action="/reminders/delete/${reminder.id}" style="display:inline;"><button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Excluir este lembrete?');"><i class="fas fa-trash-alt"></i>Excluir</button></form>`;
    return actions;
}

function updateRemindersTable() {
    fetch('/reminders/json')
      .then(response => response.json())
      .then(data => {
        const reminders = data.reminders;
        const tbody = document.querySelector('table.table tbody');
        if (!tbody) return;
        if (reminders.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7">Nenhum lembrete cadastrado.</td></tr>';
          return;
        }
        tbody.innerHTML = reminders.map(reminder => `
          <tr class="${reminder.completed ? 'table-success' : ''}">
            <td>${reminder.name}</td>
            <td>${reminder.type}</td>
            <td>${reminder.due_date}</td>
            <td>${reminder.responsible}</td>
            <td>${reminder.frequency || ''}</td>
            <td>${reminder.sector || ''}</td>
            <td>${renderStatus(reminder)}</td>
            <td>${renderActions(reminder)}</td>
          </tr>
        `).join('');
      });
}
// Atualiza a cada 3 minutos (180000 ms)
setInterval(updateRemindersTable, 180000);
// Atualiza ao carregar a página também
window.addEventListener('DOMContentLoaded', updateRemindersTable);
</script>

{% endblock %}

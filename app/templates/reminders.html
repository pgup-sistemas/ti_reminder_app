{% extends 'base.html' %}
{% block title %}Gestão de Lembretes | TI OSN System {% endblock %}

{% block content %}

<!-- Header da Página -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="text-primary mb-0"><i class="fas fa-bell me-2"></i>Gerenciar Lembretes</h4>
    <div class="badge bg-primary fs-6" id="reminders-count">
        Carregando...
    </div>
</div>

<!-- Card de Nova Tarefa -->
<div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-light border-0 py-3">
        <h6 class="mb-0 text-secondary">
            <i class="fas fa-plus-circle me-2"></i>
            {% if edit_id %}Editar{% else %}Novo{% endif %} Lembrete
            {% if edit_id %}
                <small class="text-warning ms-2">
                    <i class="fas fa-edit me-1"></i>Editando lembrete
                    <a href="{{ url_for('main.reminders') }}" class="text-warning text-decoration-none ms-2">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </a>
                </small>
            {% endif %}
        </h6>
    </div>
    <div class="card-body">
        <form method="POST">
            {{ form.hidden_tag() }}
            <div class="row g-3">
                <div class="col-xl-3 col-lg-4 col-md-6">
                    <label class="form-label small text-muted mb-1">Nome do Lembrete</label>
                    {{ form.name(class_='form-control form-control-sm', placeholder='Digite o nome do lembrete...') }}
                    {% for error in form.name.errors %}
                        <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label small text-muted mb-1">Tipo</label>
                    {{ form.type(class_='form-control form-control-sm') }}
                    {% for error in form.type.errors %}
                        <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label small text-muted mb-1">Data de Vencimento</label>
                    {{ form.due_date(class_='form-control form-control-sm') }}
                    {% for error in form.due_date.errors %}
                        <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label small text-muted mb-1">Responsável</label>
                    {{ form.responsible(class_='form-control form-control-sm', placeholder='Nome do responsável') }}
                    {% for error in form.responsible.errors %}
                        <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label small text-muted mb-1">Frequência</label>
                    {{ form.frequency(class_='form-select form-select-sm') }}
                    {% for error in form.frequency.errors %}
                        <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label small text-muted mb-1">Setor</label>
                    {{ form.sector_id(class_='form-select form-select-sm') }}
                    {% for error in form.sector_id.errors %}
                        <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                    {% endfor %}
                    <div class="mt-2">
                        <label class="form-label small text-muted mb-1">Ou novo setor:</label>
                        {{ form.new_sector(class_='form-control form-control-sm', placeholder='Digite um novo setor...') }}
                    </div>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label small text-muted mb-1">Status</label>
                    {{ form.status(class_='form-select form-select-sm') }}
                    {% for error in form.status.errors %}
                        <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label small text-muted mb-1">Pausar até</label>
                    {{ form.pause_until(class_='form-control form-control-sm') }}
                    {% for error in form.pause_until.errors %}
                        <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4">
                    <label class="form-label small text-muted mb-1">Data Final</label>
                    {{ form.end_date(class_='form-control form-control-sm') }}
                    {% for error in form.end_date.errors %}
                        <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-xl-12">
                    <hr class="my-3">
                    <div class="d-flex justify-content-end">
                        {% if edit_id %}
                            <button type="submit" class="btn btn-warning btn-sm px-4">
                                <i class="fas fa-save me-1"></i>Atualizar
                            </button>
                        {% else %}
                            {{ form.submit(class_='btn btn-success btn-sm px-4') }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Card de Lista de Lembretes -->
<div class="card shadow-sm border-0">
    <div class="card-header bg-light border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 text-secondary"><i class="fas fa-list-check me-2"></i>Lista de Lembretes</h6>
            <div class="d-flex gap-2 align-items-center">
                <!-- Ordenação -->
                <select class="form-select form-select-sm" onchange="location.href = this.value" style="width: auto;">
                    <option value="">Ordenar por...</option>
                    <option value="{{ url_for('main.reminders', order_by='due_date', order='desc') }}">Data mais recente</option>
                    <option value="{{ url_for('main.reminders', order_by='due_date', order='asc') }}">Data mais antiga</option>
                    <option value="{{ url_for('main.reminders', order_by='name', order='asc') }}">Nome (A-Z)</option>
                    <option value="{{ url_for('main.reminders', order_by='name', order='desc') }}">Nome (Z-A)</option>
                </select>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 500px;">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light sticky-top">
                    <tr>
                        <th class="ps-3"><i class="fas fa-tag me-2 text-muted"></i>Nome</th>
                        <th><i class="fas fa-list me-2 text-muted"></i>Tipo</th>
                        <th><i class="fas fa-calendar-alt me-2 text-muted"></i>Vencimento</th>
                        <th><i class="fas fa-user me-2 text-muted"></i>Responsável</th>
                        <th><i class="fas fa-sync-alt me-2 text-muted"></i>Frequência</th>
                        <th><i class="fas fa-sitemap me-2 text-muted"></i>Setor</th>
                        <th class="text-center"><i class="fas fa-check-circle me-2 text-muted"></i>Status</th>
                        <th class="text-center pe-3"><i class="fas fa-cogs me-2 text-muted"></i>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>Carregando lembretes...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer py-2">
        <div class="d-flex justify-content-between align-items-center">
            <span class="page-info small text-muted">Carregando...</span>
            <nav aria-label="Navegação de páginas">
                <ul class="pagination pagination-sm mb-0">
                    <!-- A paginação será carregada via JavaScript -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
function renderStatus(reminder) {
    if (reminder.completed) {
        return '<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 d-inline-flex align-items-center gap-1">' +
               '<i class="fas fa-check-circle"></i> Concluído</span>';
    } else if (reminder.status_control === 'pausado') {
        let pauseInfo = '';
        if (reminder.pause_until) {
            pauseInfo = ` até ${new Date(reminder.pause_until).toLocaleDateString('pt-BR')}`;
        }
        return `<span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 d-inline-flex align-items-center gap-1">
               <i class="fas fa-pause-circle"></i> Pausado${pauseInfo}</span>`;
    } else if (reminder.status_control === 'cancelado') {
        return '<span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 d-inline-flex align-items-center gap-1">' +
               '<i class="fas fa-ban"></i> Cancelado</span>';
    } else if (reminder.status === 'ok') {
        return '<span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 d-inline-flex align-items-center gap-1">' +
               '<i class="fas fa-check"></i> Ok</span>';
    } else if (reminder.status === 'alert') {
        return '<span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 d-inline-flex align-items-center gap-1">' +
               '<i class="fas fa-calendar-day"></i> Em breve</span>';
    } else if (reminder.status === 'expired') {
        return '<span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 d-inline-flex align-items-center gap-1">' +
               '<i class="fas fa-exclamation-circle"></i> Vencido</span>';
    }
    return '<span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 d-inline-flex align-items-center gap-1">' +
           '<i class="fas fa-clock"></i> Pendente</span>';
}

function renderActions(reminder) {
    let actions = `<div class="d-flex gap-1 justify-content-center">
        <a href="/reminders/edit/${reminder.id}" class="btn btn-sm btn-warning" title="Editar">
            <i class="fas fa-edit"></i>
        </a>`;
    
    if (!reminder.completed) {
        actions += `
        <form method="POST" action="/reminders/complete/${reminder.id}" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-success" title="Finalizar">
                <i class="fas fa-check"></i>
            </button>
        </form>`;
        
        // Botão de pausar/reativar/cancelar
        if (reminder.status_control === 'ativo') {
            actions += `
        <form method="POST" action="/reminders/toggle_status/${reminder.id}" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-secondary" title="Pausar">
                <i class="fas fa-pause"></i>
            </button>
        </form>`;
        } else if (reminder.status_control === 'pausado' || reminder.status_control === 'cancelado') {
            actions += `
        <form method="POST" action="/reminders/toggle_status/${reminder.id}" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-info" title="Reativar">
                <i class="fas fa-play"></i>
            </button>
        </form>`;
        }
        
        // Botão de cancelar (apenas para lembretes ativos ou pausados)
        if (reminder.status_control !== 'cancelado') {
            actions += `
        <form method="POST" action="/reminders/toggle_status/${reminder.id}" style="display:inline;">
            <input type="hidden" name="target_status" value="cancelado">
            <button type="submit" class="btn btn-sm btn-danger" title="Cancelar" 
                    onclick="return confirm('Tem certeza que deseja cancelar este lembrete?');">
                <i class="fas fa-ban"></i>
            </button>
        </form>`;
        }
    }
    
    actions += `
        <form method="POST" action="/reminders/delete/${reminder.id}" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Excluir este lembrete?');" title="Excluir">
                <i class="fas fa-trash-alt"></i>
            </button>
        </form>
    </div>`;
    return actions;
}

function updateRemindersTable() {
    const url = new URL(window.location.href);
    const params = new URLSearchParams(url.search);
    const page = params.get('page') || 1;
    const orderBy = params.get('order_by') || 'id';
    const order = params.get('order') || 'desc';
    
    fetch(`/reminders/json?page=${page}&order_by=${orderBy}&order=${order}`)
        .then(response => response.json())
        .then(data => {
            const reminders = data.reminders;
            const tbody = document.querySelector('table.table tbody');
            const pagination = document.querySelector('.pagination');
            const pageInfo = document.querySelector('.page-info');
            const remindersCount = document.querySelector('#reminders-count');
            
            if (!tbody) return;
            
            // Atualiza o contador
            if (remindersCount) {
                remindersCount.innerHTML = `${data.total || 0} lembrete${data.total !== 1 ? 's' : ''}`;
            }
            
            // Atualiza a tabela
            if (reminders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">' +
                    '<i class="fas fa-inbox fa-2x mb-2 d-block"></i>Nenhum lembrete cadastrado</td></tr>';
            } else {
                tbody.innerHTML = reminders.map(reminder => `
                    <tr class="${reminder.completed ? 'table-success' : ''}">
                        <td class="ps-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-bell text-muted me-2"></i>
                                <span class="${reminder.completed ? 'text-decoration-line-through text-muted' : ''}">
                                    ${reminder.name}
                                </span>
                            </div>
                        </td>
                        <td>${reminder.type}</td>
                        <td>
                            <small class="${reminder.status === 'expired' ? 'text-danger' : reminder.status === 'alert' ? 'text-warning' : 'text-dark'}">
                                ${reminder.due_date}
                            </small>
                        </td>
                        <td>${reminder.responsible}</td>
                        <td>
                            <span class="badge bg-light text-dark border">${reminder.frequency || ''}</span>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">${reminder.sector || ''}</span>
                        </td>
                        <td class="text-center">${renderStatus(reminder)}</td>
                        <td class="text-center pe-3">${renderActions(reminder)}</td>
                    </tr>
                `).join('');
            }
            
            // Atualiza a paginação
            if (pageInfo) {
                pageInfo.innerHTML = `Mostrando ${reminders.length} de ${data.total} lembretes`;
            }
            
            if (pagination && data.pages > 1) {
                let paginationHtml = '';
                
                // Botão Anterior
                if (data.has_prev) {
                    params.set('page', data.current_page - 1);
                    paginationHtml += `
                        <li class="page-item">
                            <a class="page-link" href="?${params.toString()}">
                                <i class="fas fa-chevron-left me-1"></i>Anterior
                            </a>
                        </li>`;
                } else {
                    paginationHtml += `
                        <li class="page-item disabled">
                            <span class="page-link"><i class="fas fa-chevron-left me-1"></i>Anterior</span>
                        </li>`;
                }
                
                // Páginas
                for (let p = 1; p <= data.pages; p++) {
                    if (p === data.current_page) {
                        paginationHtml += `
                            <li class="page-item active">
                                <span class="page-link">${p}</span>
                            </li>`;
                    } else {
                        params.set('page', p);
                        paginationHtml += `
                            <li class="page-item">
                                <a class="page-link" href="?${params.toString()}">${p}</a>
                            </li>`;
                    }
                }
                
                // Botão Próximo
                if (data.has_next) {
                    params.set('page', data.current_page + 1);
                    paginationHtml += `
                        <li class="page-item">
                            <a class="page-link" href="?${params.toString()}">
                                Próxima<i class="fas fa-chevron-right ms-1"></i>
                            </a>
                        </li>`;
                } else {
                    paginationHtml += `
                        <li class="page-item disabled">
                            <span class="page-link">Próxima<i class="fas fa-chevron-right ms-1"></i></span>
                        </li>`;
                }
                
                pagination.innerHTML = paginationHtml;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar lembretes:', error);
            const tbody = document.querySelector('table.table tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-danger">' +
                    '<i class="fas fa-exclamation-triangle me-2"></i>Erro ao carregar lembretes</td></tr>';
            }
        });
}

// Atualiza a cada 3 minutos (180000 ms)
setInterval(updateRemindersTable, 180000);

// Atualiza ao carregar a página também
window.addEventListener('DOMContentLoaded', updateRemindersTable);

// Atualiza a tabela quando os parâmetros da URL mudam
window.addEventListener('popstate', updateRemindersTable);
</script>

{% endblock %}
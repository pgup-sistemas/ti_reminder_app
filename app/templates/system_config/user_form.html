{% extends 'system_config_base.html' %}
{% block breadcrumb_title %}{{ 'Editar Usuário' if is_edit else 'Novo Usuário' }}{% endblock %}

{% block config_content %}
<div class="config-card">
    <div class="config-card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0">
                    <i class="fas fa-{{ 'user-edit' if is_edit else 'user-plus' }} me-2"></i>
                    {{ 'Editar Usuário' if is_edit else 'Novo Usuário' }}
                </h3>
                <p class="text-muted mb-0 mt-1">
                    {{ 'Atualize as informações do usuário' if is_edit else 'Cadastre um novo usuário no sistema' }}
                </p>
            </div>
            <a href="{{ url_for('system_config.list_users') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
        </div>
    </div>

    <form method="POST" novalidate id="userForm">
        {{ form.hidden_tag() }}
        <div class="config-card-body">
            
            <!-- Exibir erros gerais do formulário -->
            {% if form.errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <h5 class="alert-heading">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Erros de Validação
                </h5>
                <hr>
                <ul class="mb-0">
                    {% for field, errors in form.errors.items() %}
                        {% for error in errors %}
                        <li><strong>{{ form[field].label.text }}:</strong> {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            <div class="row">
                <!-- Informações Básicas -->
                <div class="col-md-6">
                    <h5 class="mb-3">
                        <i class="fas fa-user me-2"></i>
                        Informações Básicas
                    </h5>

                    <div class="mb-3">
                        {{ form.username.label(class="form-label") }}
                        {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else "")) }}
                        {% if form.username.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.username.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        {{ form.email.label(class="form-label") }}
                        {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else "")) }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.email.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        {{ form.sector_id.label(class="form-label") }}
                        {{ form.sector_id(class="form-select" + (" is-invalid" if form.sector_id.errors else "")) }}
                        {% if form.sector_id.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.sector_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Permissões -->
                <div class="col-md-6">
                    <h5 class="mb-3">
                        <i class="fas fa-shield-alt me-2"></i>
                        Permissões
                    </h5>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.is_admin(class="form-check-input") }}
                            {{ form.is_admin.label(class="form-check-label fw-bold") }}
                            <small class="form-text text-muted">
                                Acesso completo ao sistema administrativo
                            </small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.is_ti(class="form-check-input") }}
                            {{ form.is_ti.label(class="form-check-label fw-bold") }}
                            <small class="form-text text-muted">
                                Equipe de Tecnologia da Informação
                            </small>
                        </div>
                    </div>

                    {% if is_edit %}
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   id="ativo" name="ativo" {% if user.ativo %}checked{% endif %}>
                            <label class="form-check-label fw-bold" for="ativo">
                                Usuário Ativo
                            </label>
                            <small class="form-text text-muted">
                                Permite ou bloqueia o acesso ao sistema
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Senha -->
            <div class="row mt-4">
                <div class="col-12">
                    <h5 class="mb-3">
                        <i class="fas fa-key me-2"></i>
                        Senha
                    </h5>

                    {% if is_edit %}
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.change_password(class="form-check-input") }}
                            {{ form.change_password.label(class="form-check-label fw-bold") }}
                        </div>
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.new_password.label(class="form-label") }}
                                {{ form.new_password(class="form-control" + (" is-invalid" if form.new_password.errors else "")) }}
                                {% if form.new_password.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.new_password.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    {% if is_edit %}
                                        Deixe em branco para manter a senha atual
                                    {% else %}
                                        Mínimo 6 caracteres
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.confirm_password.label(class="form-label") }}
                                {{ form.confirm_password(class="form-control" + (" is-invalid" if form.confirm_password.errors else "")) }}
                                {% if form.confirm_password.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.confirm_password.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if is_edit %}
            <!-- Informações do Sistema -->
            <div class="row mt-4">
                <div class="col-12">
                    <h5 class="mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações do Sistema
                    </h5>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <div class="h6 mb-1">ID do Usuário</div>
                                <div class="text-muted fw-bold">{{ user.id }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <div class="h6 mb-1">Data de Criação</div>
                                <div class="text-muted fw-bold">
                                    {% if user.created_at %}
                                        {{ user.created_at.strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                        Não informado
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <div class="h6 mb-1">Último Login</div>
                                <div class="text-muted fw-bold">
                                    {% if user.last_login %}
                                        {{ user.last_login.strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                        Nunca acessou
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <div class="h6 mb-1">Status da Conta</div>
                                <span class="badge bg-{{ 'success' if user.ativo else 'danger' }} fs-6">
                                    {{ 'Ativa' if user.ativo else 'Inativa' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="config-actions">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    * Campos obrigatórios
                </small>
                <div class="btn-group">
                    <a href="{{ url_for('system_config.list_users') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i>
                        {{ 'Atualizar' if is_edit else 'Criar' }} Usuário
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Script de validação de senha -->
<!-- password-validator.js removido temporariamente - causava bloqueio de submit -->

<script>
// Toggle de mudança de senha e utilidades do formulário
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('userForm');
    const submitButton = form.querySelector('button[type="submit"]');
    const emailField = form.querySelector('input[name="email"]');

    const changePasswordCheckbox = document.querySelector('input[name="change_password"]');
    const passwordFields = document.querySelectorAll('input[name="new_password"], input[name="confirm_password"]');

    if (changePasswordCheckbox) {
        function togglePasswordFields() {
            const isChecked = changePasswordCheckbox.checked;
            passwordFields.forEach(field => {
                field.required = isChecked;
                // NÃO desabilitar os campos - apenas torná-los required ou não
                // Campos desabilitados não são enviados no POST
                if (!isChecked) {
                    field.value = ''; // Limpa o valor quando não está marcado
                }
                // Adiciona feedback visual
                const parentDiv = field.closest('.mb-3');
                if (parentDiv) {
                    if (isChecked) {
                        parentDiv.classList.remove('opacity-50');
                        field.readOnly = false;
                    } else {
                        parentDiv.classList.add('opacity-50');
                        field.readOnly = true; // readonly ao invés de disabled
                    }
                }
            });
        }

        changePasswordCheckbox.addEventListener('change', togglePasswordFields);
        togglePasswordFields(); // Inicial
    }

    // Validação SIMPLES de senha (SEM PasswordValidatorUI que pode bloquear)
    const newPasswordField = document.querySelector('input[name="new_password"]');
    const confirmPasswordField = document.querySelector('input[name="confirm_password"]');

    // Validação mínima de confirmação de senha
    if (newPasswordField && confirmPasswordField) {
        confirmPasswordField.addEventListener('blur', function() {
            const password = newPasswordField.value;
            const confirmPassword = confirmPasswordField.value;

            if (password && confirmPassword && password !== confirmPassword) {
                confirmPasswordField.setCustomValidity('As senhas não coincidem');
            } else {
                confirmPasswordField.setCustomValidity('');
            }
        });
    }

    // Sanitiza email antes do envio e evita double submit
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('=== FORMULÁRIO SENDO SUBMETIDO ===');
            console.log('Form action:', form.action);
            console.log('Form method:', form.method);
            console.log('Username:', form.querySelector('input[name="username"]')?.value);
            console.log('Email:', form.querySelector('input[name="email"]')?.value);
            console.log('CSRF Token presente:', !!form.querySelector('input[name="csrf_token"]'));
            console.log('Change password:', changePasswordCheckbox?.checked);
            
            // Limpar validações customizadas que podem bloquear submit
            if (confirmPasswordField) {
                confirmPasswordField.setCustomValidity('');
            }
            if (newPasswordField) {
                newPasswordField.setCustomValidity('');
            }
            
            if (emailField) {
                emailField.value = emailField.value.trim().toLowerCase();
            }

            // Desabilitar botão de submit para evitar duplo clique
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.classList.add('disabled');
                
                // Adicionar indicador visual de loading
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Salvando...';
            }
            
            console.log('✓ Submit permitido, enviando formulário...');
        });
    }
});
</script>
{% endblock %}
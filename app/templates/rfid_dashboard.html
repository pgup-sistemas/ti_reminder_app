{% extends "base.html" %}

{% block title %}Dashboard RFID - Sistema TI OSN{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-gradient-success text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-wifi"></i> Dashboard RFID - Rastreamento de Equipamentos
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-light btn-sm" onclick="location.href='{{ url_for('main.bulk_assign_rfid') }}'">
                            <i class="fas fa-plus"></i> Atribuição em Lote
                        </button>
                    </div>
                </div>
                <div class="card-body">

                    <!-- Estatísticas RFID -->
                    <div class="row g-3 mb-4">
                        <div class="col-lg-3 col-md-6">
                            <div class="card card-service h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">Equipamentos RFID</h6>
                                            <p class="text-muted small mb-0">Total com tags RFID</p>
                                        </div>
                                        <div class="bg-info bg-opacity-10 p-2 rounded">
                                            <i class="fas fa-tag text-info"></i>
                                        </div>
                                    </div>
                                    <h3 class="text-info mb-3">{{ total_rfid_equipment }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card card-service h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">Equipamentos Ativos</h6>
                                            <p class="text-muted small mb-0">RFID funcionando</p>
                                        </div>
                                        <div class="bg-success bg-opacity-10 p-2 rounded">
                                            <i class="fas fa-check-circle text-success"></i>
                                        </div>
                                    </div>
                                    <h3 class="text-success mb-3">{{ active_rfid_equipment }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card card-service h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">Equipamentos Perdidos</h6>
                                            <p class="text-muted small mb-0">Não localizados</p>
                                        </div>
                                        <div class="bg-warning bg-opacity-10 p-2 rounded">
                                            <i class="fas fa-exclamation-triangle text-warning"></i>
                                        </div>
                                    </div>
                                    <h3 class="text-warning mb-3">{{ lost_count }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card card-service h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">Leitores Online</h6>
                                            <p class="text-muted small mb-0">Pontos de leitura</p>
                                        </div>
                                        <div class="bg-primary bg-opacity-10 p-2 rounded">
                                            <i class="fas fa-wifi text-primary"></i>
                                        </div>
                                    </div>
                                    <h3 class="text-primary mb-3">{{ reader_status.online_readers }}/{{ reader_status.total_readers }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status dos Leitores RFID -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-server"></i> Status dos Leitores RFID
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        {% for reader_id, reader_info in reader_status.readers.items() %}
                                        <div class="col-md-3 mb-3">
                                            <div class="card {% if reader_info.status == 'online' %}border-success shadow-sm{% else %}border-danger shadow-sm{% endif %} h-100">
                                                <div class="card-body text-center">
                                                    <div class="mb-2">
                                                        <i class="fas fa-wifi fa-2x {% if reader_info.status == 'online' %}text-success{% else %}text-danger{% endif %}"></i>
                                                    </div>
                                                    <h6 class="font-weight-bold">{{ reader_info.location }}</h6>
                                                    <p class="mb-2 text-muted small">{{ reader_id }}</p>
                                                    <span class="badge badge-lg {% if reader_info.status == 'online' %}badge-success{% else %}badge-danger{% endif %}">
                                                        <i class="fas fa-circle"></i> {{ reader_info.status|title }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Equipamentos Perdidos -->
                    {% if lost_equipment %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-warning">
                                <div class="card-header bg-warning">
                                    <h5 class="card-title">
                                        <i class="fas fa-exclamation-triangle"></i> Equipamentos Perdidos/Desconhecidos
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Descrição</th>
                                                    <th>Tag RFID</th>
                                                    <th>Última Leitura</th>
                                                    <th>Status</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for equipment in lost_equipment %}
                                                <tr>
                                                    <td>{{ equipment.id }}</td>
                                                    <td>{{ equipment.description[:50] }}...</td>
                                                    <td><code>{{ equipment.rfid_tag }}</code></td>
                                                    <td>
                                                        {% if equipment.rfid_last_scan %}
                                                            {{ equipment.rfid_last_scan.strftime('%d/%m/%Y %H:%M') }}
                                                        {% else %}
                                                            <span class="text-muted">Nunca</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-warning">{{ equipment.rfid_status|title }}</span>
                                                    </td>
                                                    <td>
                                                        <a href="{{ url_for('equipment_v2.catalog') }}" class="btn btn-sm btn-primary">
                                                            <i class="fas fa-eye"></i> Ver
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Todos os Equipamentos com RFID -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-list"></i> Todos os Equipamentos com RFID
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th><i class="fas fa-hashtag"></i> ID</th>
                                                    <th><i class="fas fa-tag"></i> Descrição</th>
                                                    <th><i class="fas fa-wifi"></i> Tag RFID</th>
                                                    <th><i class="fas fa-map-marker-alt"></i> Localização</th>
                                                    <th><i class="fas fa-clock"></i> Última Leitura</th>
                                                    <th><i class="fas fa-signal"></i> Status RFID</th>
                                                    <th><i class="fas fa-cog"></i> Status Geral</th>
                                                    <th><i class="fas fa-tools"></i> Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for equipment in rfid_equipment %}
                                                <tr>
                                                    <td class="font-weight-bold">#{{ equipment.id }}</td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div>
                                                                <div class="font-weight-bold">{{ equipment.description[:30] }}{% if equipment.description|length > 30 %}...{% endif %}</div>
                                                                <small class="text-muted">{{ equipment.equipment_type or 'N/A' }}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td><code class="badge badge-secondary">{{ equipment.rfid_tag }}</code></td>
                                                    <td>
                                                        {% if equipment.rfid_last_location %}
                                                            <span class="badge badge-info badge-lg">{{ equipment.rfid_last_location }}</span>
                                                        {% else %}
                                                            <span class="text-muted"><i class="fas fa-question-circle"></i> Desconhecida</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if equipment.rfid_last_scan %}
                                                            <span class="text-success">
                                                                <i class="fas fa-check-circle"></i> {{ equipment.rfid_last_scan.strftime('%d/%m/%Y %H:%M') }}
                                                            </span>
                                                        {% else %}
                                                            <span class="text-muted"><i class="fas fa-times-circle"></i> Nunca</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if equipment.rfid_status == 'ativo' %}
                                                            <span class="badge badge-success badge-lg">
                                                                <i class="fas fa-check-circle"></i> Ativo
                                                            </span>
                                                        {% elif equipment.rfid_status == 'perdido' %}
                                                            <span class="badge badge-danger badge-lg">
                                                                <i class="fas fa-exclamation-triangle"></i> Perdido
                                                            </span>
                                                        {% else %}
                                                            <span class="badge badge-secondary badge-lg">{{ equipment.rfid_status|title }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if equipment.status == 'Entregue' %}
                                                            <span class="badge badge-success badge-lg">
                                                                <i class="fas fa-check-circle"></i> {{ equipment.status }}
                                                            </span>
                                                        {% elif equipment.status == 'Devolvido' %}
                                                            <span class="badge badge-info badge-lg">
                                                                <i class="fas fa-undo"></i> {{ equipment.status }}
                                                            </span>
                                                        {% else %}
                                                            <span class="badge badge-warning badge-lg">
                                                                <i class="fas fa-clock"></i> {{ equipment.status }}
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{{ url_for('equipment_v2.catalog') }}" class="btn btn-outline-primary" title="Ver Detalhes">
                                                                <i class="fas fa-eye"></i>
                                                            </a>
                                                            <button type="button" class="btn btn-outline-info" onclick="getLocation({{ equipment.id }})" title="Ver Localização">
                                                                <i class="fas fa-map-marker-alt"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-warning" onclick="simulateScan('{{ equipment.rfid_tag }}', 'reader_office_a')" title="Simular Leitura">
                                                                <i class="fas fa-play"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para localização -->
<div class="modal fade" id="locationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Localização do Equipamento</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="locationContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Função para obter localização
function getLocation(equipmentId) {
    $('#locationModal').modal('show');
    $('#locationContent').html(`
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="sr-only">Carregando...</span>
            </div>
            <p>Obtendo localização...</p>
        </div>
    `);

    fetch(`/rfid/location/${equipmentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#locationContent').html(`
                    <div class="alert alert-success">
                        <h6><i class="fas fa-map-marker-alt"></i> Localização Atual</h6>
                        <p class="mb-1"><strong>Local:</strong> ${data.location || 'Desconhecida'}</p>
                        <p class="mb-1"><strong>Status:</strong> ${data.status}</p>
                        <p class="mb-0"><strong>Última leitura:</strong> ${data.last_scan ? new Date(data.last_scan).toLocaleString('pt-BR') : 'Nunca'}</p>
                    </div>
                `);
            } else {
                $('#locationContent').html(`
                    <div class="alert alert-warning">
                        <p>${data.message}</p>
                    </div>
                `);
            }
        })
        .catch(error => {
            $('#locationContent').html(`
                <div class="alert alert-danger">
                    <p>Erro ao obter localização: ${error.message}</p>
                </div>
            `);
        });
}

// Função para simular leitura RFID
function simulateScan(rfidTag, readerId) {
    if (confirm(`Simular leitura RFID da tag ${rfidTag} no leitor ${readerId}?`)) {
        fetch(`/rfid/simulate/${rfidTag}/${readerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                Feedback.error('Erro', 'Erro na simulação');
            }
        })
        .catch(error => {
            alert('Erro: ' + error.message);
        });
    }
}

// Atualização automática do status a cada 30 segundos
setInterval(() => {
    fetch('/api/rfid/status')
        .then(response => response.json())
        .then(data => {
            // Atualizar contadores se necessário
            console.log('Status RFID atualizado:', data);
        })
        .catch(error => console.error('Erro ao atualizar status RFID:', error));
}, 30000);
</script>

<style>
.badge {
    font-size: 0.75em;
}

.badge-lg {
    font-size: 0.9em;
    padding: 0.5em 0.75em;
}

.table td {
    vertical-align: middle;
}

.small-box {
    margin-bottom: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-tools .btn {
    margin-left: 5px;
    border-radius: 6px;
}

.card {
    border-radius: 8px;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.card-header {
    border-radius: 8px 8px 0 0 !important;
    border: none;
}

.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.shadow-sm {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.table-hover tbody tr:hover {
    background-color: rgba(40, 167, 69, 0.05);
}

.font-weight-bold {
    font-weight: 600 !important;
}

.h-100 {
    height: 100% !important;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
}

.btn-outline-primary:hover, .btn-outline-info:hover, .btn-outline-warning:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style>
{% endblock %}
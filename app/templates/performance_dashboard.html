{% extends "base.html" %}

{% block title %}Performance Operacional | TI OSN System{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb breadcrumb-sm mb-1">
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.index') }}" class="d-inline-flex align-items-center gap-2">
                    <i class="fas fa-th-large text-primary"></i>
                    <span>Meu Workspace</span>
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <span class="d-inline-flex align-items-center gap-2">
                    <i class="fas fa-tachometer-alt text-primary"></i>
                    <span>Performance Operacional</span>
                </span>
            </li>
        </ol>
    </nav>
    <div class="border-bottom mb-4" style="border-color: var(--bs-gray-200) !important;"></div>

    <!-- Header da Página -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="text-primary mb-1">
                <i class="fas fa-tachometer-alt me-2"></i>Performance Operacional
            </h4>
            <p class="text-muted mb-0 small">Monitoramento em tempo real da infraestrutura e do banco corporativo</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="runOptimizations()">
                <i class="fas fa-wrench me-1"></i>Otimizar
            </button>
            <a href="{{ url_for('main.performance_report') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-file-pdf me-1"></i>Relatório
            </a>
            <button type="button" class="btn btn-outline-success btn-sm" onclick="refreshMetrics()">
                <i class="fas fa-sync-alt me-1"></i>Atualizar
            </button>
        </div>
    </div>

    <!-- Alertas de Performance -->
    {% if performance_report.recommendations %}
    <div class="alert alert-warning border-0 mb-4" role="alert">
        <div class="d-flex align-items-start">
            <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
            <div class="flex-grow-1">
                <h6 class="alert-heading mb-2">Recomendações de Performance</h6>
                <ul class="mb-0 ps-3">
                    {% for rec in performance_report.recommendations %}
                    <li class="mb-1">{{ rec }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Métricas do Sistema -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="text-muted mb-1 fw-medium">CPU</h6>
                            <p class="text-muted small mb-0">Processador</p>
                        </div>
                        <div class="bg-info bg-opacity-10 p-2 rounded">
                            <i class="fas fa-microchip text-info"></i>
                        </div>
                    </div>
                    <h3 class="text-info mb-2 fw-bold" id="cpu-value">{{ "%.1f"|format(system_metrics.cpu_percent) }}%</h3>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-info" id="cpu-bar" style="width: {{ system_metrics.cpu_percent }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="text-muted mb-1 fw-medium">Memória</h6>
                            <p class="text-muted small mb-0">RAM</p>
                        </div>
                        <div class="bg-success bg-opacity-10 p-2 rounded">
                            <i class="fas fa-memory text-success"></i>
                        </div>
                    </div>
                    <h3 class="text-success mb-2 fw-bold" id="memory-value">{{ "%.1f"|format(system_metrics.memory_percent) }}%</h3>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-success" id="memory-bar" style="width: {{ system_metrics.memory_percent }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="text-muted mb-1 fw-medium">Disco</h6>
                            <p class="text-muted small mb-0">Armazenamento</p>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-2 rounded">
                            <i class="fas fa-hdd text-warning"></i>
                        </div>
                    </div>
                    <h3 class="text-warning mb-2 fw-bold" id="disk-value">{{ "%.1f"|format(system_metrics.disk_percent) }}%</h3>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-warning" id="disk-bar" style="width: {{ system_metrics.disk_percent }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="text-muted mb-1 fw-medium">Conexões DB</h6>
                            <p class="text-muted small mb-0">Banco de dados</p>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-2 rounded">
                            <i class="fas fa-database text-primary"></i>
                        </div>
                    </div>
                    <h3 class="text-primary mb-2 fw-bold" id="db-value">{{ db_stats.active_connections }}</h3>
                    <p class="text-muted small mb-0">conexões ativas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas Detalhadas -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 fw-medium"><i class="fas fa-server me-2 text-primary"></i>Recursos do Sistema</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td class="text-muted">Memória Usada:</td>
                            <td class="text-end"><span class="badge bg-success">{{ "%.2f"|format(system_metrics.memory_used_gb) }} GB</span></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Disco Usado:</td>
                            <td class="text-end"><span class="badge bg-warning text-dark">{{ "%.2f"|format(system_metrics.disk_used_gb) }} GB</span></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Memória da App:</td>
                            <td class="text-end"><span class="badge bg-info">{{ "%.2f"|format(system_metrics.app_memory_mb) }} MB</span></td>
                        </tr>
                        <tr>
                            <td class="text-muted">CPU da App:</td>
                            <td class="text-end"><span class="badge bg-primary">{{ "%.1f"|format(system_metrics.app_cpu_percent) }}%</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 fw-medium"><i class="fas fa-database me-2 text-primary"></i>Banco de Dados</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td class="text-muted">Conexões Ativas:</td>
                            <td class="text-end"><span class="badge bg-primary">{{ db_stats.active_connections }}</span></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Cache Hit Ratio:</td>
                            <td class="text-end">
                                <span class="badge bg-{{ 'success' if db_stats.get('cache_hit_ratio', 0) >= 95 else 'warning' }}">
                                    {{ "%.1f"|format(db_stats.get('cache_hit_ratio', 0)) }}%
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Status:</td>
                            <td class="text-end">
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle"></i> Online
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Performance -->
    <div class="row g-3 mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 fw-medium">
                        <i class="fas fa-chart-line me-2 text-primary"></i>Monitor de Recursos em Tempo Real
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 350px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>Atualizado automaticamente a cada 30 segundos
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas das Tabelas -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 fw-medium">
                        <i class="fas fa-table me-2 text-primary"></i>Estatísticas das Tabelas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-table me-1"></i>Tabela</th>
                                    <th class="text-center"><i class="fas fa-check-circle me-1"></i>Ativos</th>
                                    <th class="text-center"><i class="fas fa-times-circle me-1"></i>Mortos</th>
                                    <th class="text-center"><i class="fas fa-plus me-1"></i>Inserts</th>
                                    <th class="text-center"><i class="fas fa-edit me-1"></i>Updates</th>
                                    <th class="text-center"><i class="fas fa-trash me-1"></i>Deletes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for table in db_stats.table_stats %}
                                <tr>
                                    <td><span class="badge bg-secondary">{{ table.table }}</span></td>
                                    <td class="text-center"><span class="badge bg-success">{{ "{:,}".format(table.live_rows) }}</span></td>
                                    <td class="text-center"><span class="badge bg-danger">{{ "{:,}".format(table.dead_rows) }}</span></td>
                                    <td class="text-center"><span class="badge bg-info">{{ "{:,}".format(table.inserts) }}</span></td>
                                    <td class="text-center"><span class="badge bg-warning text-dark">{{ "{:,}".format(table.updates) }}</span></td>
                                    <td class="text-center"><span class="badge bg-danger">{{ "{:,}".format(table.deletes) }}</span></td>
                                </tr>
                                {% endfor %}
                                {% if not db_stats.table_stats %}
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                                            <p class="mb-0">Estatísticas das tabelas não disponíveis</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let performanceChart;
let metricsHistory = {
    cpu: [],
    memory: [],
    labels: []
};

document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    startRealTimeMonitoring();
});

function initializeChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU (%)',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Memória (%)',
                data: [],
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
}

function startRealTimeMonitoring() {
    setInterval(updateMetrics, 30000);
    updateMetrics();
}

function updateMetrics() {
    fetch('/api/performance/metrics')
        .then(response => response.json())
        .then(data => {
            const timestamp = new Date(data.timestamp * 1000);
            const timeLabel = timestamp.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            metricsHistory.labels.push(timeLabel);
            metricsHistory.cpu.push(data.system.cpu_percent);
            metricsHistory.memory.push(data.system.memory_percent);

            if (metricsHistory.labels.length > 20) {
                metricsHistory.labels.shift();
                metricsHistory.cpu.shift();
                metricsHistory.memory.shift();
            }

            performanceChart.data.labels = metricsHistory.labels;
            performanceChart.data.datasets[0].data = metricsHistory.cpu;
            performanceChart.data.datasets[1].data = metricsHistory.memory;
            performanceChart.update('none');

            updateDisplayValues(data);
        })
        .catch(error => console.error('Erro ao atualizar métricas:', error));
}

function updateDisplayValues(data) {
    const cpuValue = document.getElementById('cpu-value');
    const memoryValue = document.getElementById('memory-value');
    const diskValue = document.getElementById('disk-value');
    const dbValue = document.getElementById('db-value');
    const cpuBar = document.getElementById('cpu-bar');
    const memoryBar = document.getElementById('memory-bar');
    const diskBar = document.getElementById('disk-bar');

    if (cpuValue) cpuValue.textContent = data.system.cpu_percent.toFixed(1) + '%';
    if (memoryValue) memoryValue.textContent = data.system.memory_percent.toFixed(1) + '%';
    if (diskValue) diskValue.textContent = data.system.disk_percent.toFixed(1) + '%';
    if (dbValue) dbValue.textContent = data.database.active_connections;
    
    if (cpuBar) cpuBar.style.width = data.system.cpu_percent + '%';
    if (memoryBar) memoryBar.style.width = data.system.memory_percent + '%';
    if (diskBar) diskBar.style.width = data.system.disk_percent + '%';
}

function runOptimizations() {
    if (confirm('Executar otimizações de performance? Esta operação pode demorar alguns minutos.')) {
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Executando...';
        btn.disabled = true;

        fetch('/performance/optimize')
            .then(response => {
                if (response.ok) {
                    btn.innerHTML = '<i class="fas fa-check me-1"></i>Concluído!';
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error('Erro ao executar otimizações');
                }
            })
            .catch(error => {
                alert('Erro: ' + error.message);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            });
    }
}

function refreshMetrics() {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Atualizando...';
    btn.disabled = true;
    
    updateMetrics();
    
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Atualizado!';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }, 1500);
    }, 500);
}
</script>
{% endblock %}

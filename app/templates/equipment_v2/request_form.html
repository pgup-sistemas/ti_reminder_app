{% extends 'base.html' %}

{% block title %}Solicitar {{ equipment.name }} | TI OSN System{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="text-primary mb-1">
                        <i class="fas fa-paper-plane me-2"></i>Solicitar Empréstimo
                    </h4>
                    <p class="text-muted mb-0 small">Preencha os dados para solicitar o empréstimo do equipamento</p>
                </div>
                <a href="{{ url_for('equipment_v2.catalog') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Voltar
                </a>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <!-- Seção: Informações do Equipamento -->
                            <div class="mb-4">
                                <h5 class="text-secondary mb-3">
                                    <i class="fas fa-laptop me-2"></i>Equipamento Selecionado
                                </h5>
                                <div class="alert alert-info mb-0">
                                    <h6 class="mb-2"><strong>{{ equipment.name }}</strong></h6>
                                    {% if equipment.description %}
                                    <p class="mb-2 small">{{ equipment.description }}</p>
                                    {% endif %}
                                    <ul class="list-unstyled mb-0 small">
                                        {% if equipment.category %}
                                        <li><i class="fas fa-tag me-2"></i><strong>Categoria:</strong> {{ equipment.category }}</li>
                                        {% endif %}
                                        {% if equipment.brand %}
                                        <li><i class="fas fa-building me-2"></i><strong>Marca:</strong> {{ equipment.brand }}</li>
                                        {% endif %}
                                        {% if equipment.patrimony %}
                                        <li><i class="fas fa-barcode me-2"></i><strong>Patrimônio:</strong> {{ equipment.patrimony }}</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Formulário -->
                            <form method="POST" class="needs-validation" novalidate>
                                <!-- Seção: Período do Empréstimo -->
                                <div class="mb-4">
                                    <h5 class="text-secondary mb-3">
                                        <i class="fas fa-calendar-alt me-2"></i>Período do Empréstimo
                                    </h5>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="start_date" class="form-label fw-medium">
                                                <i class="fas fa-calendar me-1"></i>Data de Início <span class="text-danger">*</span>
                                            </label>
                                            <input type="date" 
                                                   class="form-control" 
                                                   id="start_date" 
                                                   name="start_date" 
                                                   min="{{ today }}" 
                                                   required>
                                            <div class="invalid-feedback">Por favor, selecione a data de início.</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="start_time" class="form-label fw-medium">
                                                <i class="fas fa-clock me-1"></i>Horário de Início <span class="text-danger">*</span>
                                            </label>
                                            <input type="time" 
                                                   class="form-control" 
                                                   id="start_time" 
                                                   name="start_time" 
                                                   value="09:00"
                                                   required>
                                            <div class="invalid-feedback">Por favor, selecione o horário de início.</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="end_date" class="form-label fw-medium">
                                                <i class="fas fa-calendar me-1"></i>Data de Devolução <span class="text-danger">*</span>
                                            </label>
                                            <input type="date" 
                                                   class="form-control" 
                                                   id="end_date" 
                                                   name="end_date" 
                                                   min="{{ today }}" 
                                                   required>
                                            <div class="invalid-feedback">Por favor, selecione a data de devolução.</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="end_time" class="form-label fw-medium">
                                                <i class="fas fa-clock me-1"></i>Horário de Devolução <span class="text-danger">*</span>
                                            </label>
                                            <input type="time" 
                                                   class="form-control" 
                                                   id="end_time" 
                                                   name="end_time" 
                                                   value="18:00"
                                                   required>
                                            <div class="invalid-feedback">Por favor, selecione o horário de devolução.</div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                A data e horário de devolução devem ser posteriores à data e horário de início.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- Seção: Finalidade -->
                                <div class="mb-4">
                                    <h5 class="text-secondary mb-3">
                                        <i class="fas fa-comment me-2"></i>Finalidade
                                    </h5>
                                    <label for="purpose" class="form-label fw-medium">
                                        <i class="fas fa-info-circle me-1"></i>Descreva a finalidade do empréstimo
                                    </label>
                                    <textarea class="form-control" 
                                              id="purpose" 
                                              name="purpose" 
                                              rows="4" 
                                              placeholder="Ex: Desenvolvimento de projeto, apresentação, trabalho remoto, etc."></textarea>
                                    <div class="form-text">Opcional, mas ajuda na aprovação da solicitação.</div>
                                </div>

                                <!-- Aviso -->
                                <div class="alert alert-warning mb-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Atenção:</strong> Sua solicitação será enviada para aprovação da equipe de TI. 
                                    Você receberá uma notificação quando for aprovada ou rejeitada.
                                </div>

                                <!-- Botões de Ação -->
                                <div class="d-flex gap-2 justify-content-end pt-3 border-top">
                                    <a href="{{ url_for('equipment_v2.catalog') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-check me-1"></i>Enviar Solicitação
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Validação de formulário conforme FRONTEND_STANDARDS
(function () {
    'use strict';
    
    const forms = document.querySelectorAll('.needs-validation');
    
    Array.from(forms).forEach(form => {
        const inputs = form.querySelectorAll('input, textarea, select');
        
        // Validação em tempo real
        inputs.forEach(input => {
            input.addEventListener('blur', function () {
                if (!input.checkValidity()) {
                    input.classList.add('is-invalid');
                    input.classList.remove('is-valid');
                } else {
                    input.classList.remove('is-invalid');
                    if (input.value) {
                        input.classList.add('is-valid');
                    }
                }
            });
        });
        
        // Validação no submit
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                
                // Focar no primeiro campo inválido
                const firstInvalid = form.querySelector(':invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
            }
            
            form.classList.add('was-validated');
        });
    });
})();

// Validação de datas e horários
document.addEventListener('DOMContentLoaded', function() {
    const startDate = document.getElementById('start_date');
    const startTime = document.getElementById('start_time');
    const endDate = document.getElementById('end_date');
    const endTime = document.getElementById('end_time');
    const today = new Date().toISOString().split('T')[0];
    
    // Definir data mínima
    startDate.min = today;
    endDate.min = today;
    
    // Validar que end_date >= start_date
    startDate.addEventListener('change', function() {
        endDate.min = this.value;
        if (endDate.value && endDate.value < this.value) {
            endDate.value = this.value;
        }
        validateDateTime();
    });
    
    // Validar horários quando mudarem
    startTime.addEventListener('change', validateDateTime);
    endDate.addEventListener('change', validateDateTime);
    endTime.addEventListener('change', validateDateTime);
    
    function validateDateTime() {
        if (!startDate.value || !startTime.value || !endDate.value || !endTime.value) {
            return;
        }
        
        const start = new Date(startDate.value + 'T' + startTime.value);
        const end = new Date(endDate.value + 'T' + endTime.value);
        
        if (end <= start) {
            endTime.setCustomValidity('O horário de devolução deve ser posterior ao horário de início');
            endTime.classList.add('is-invalid');
        } else {
            endTime.setCustomValidity('');
            endTime.classList.remove('is-invalid');
            if (endTime.value) {
                endTime.classList.add('is-valid');
            }
        }
    }
});
</script>
{% endblock %}

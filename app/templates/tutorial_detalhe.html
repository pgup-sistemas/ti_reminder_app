{% extends 'base.html' %}
{% block title %}{{ tutorial.titulo }} - TI OSN System{% endblock %}
{% block content %}

<!-- Header da Página -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="text-primary mb-0"><i class="fas fa-book me-2"></i>Detalhes do Tutorial</h4>
    <a href="{{ url_for('main.listar_tutoriais') }}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i>Voltar
    </a>
</div>

<!-- Card Principal do Tutorial -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-light border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 text-secondary"><i class="fas fa-info-circle me-2"></i>{{ tutorial.titulo }}</h6>
            <a href="{{ url_for('main.exportar_tutorial_pdf', tutorial_id=tutorial.id) }}" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-file-pdf me-1"></i>Exportar PDF
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Informações Básicas -->
        <div class="row g-4 mb-4">
            <div class="col-lg-4">
                <div class="mb-3">
                    <label class="form-label small text-muted mb-1">Categoria</label>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-tag text-muted me-2"></i>
                        <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                            {{ tutorial.categoria or 'Sem categoria' }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="mb-3">
                    <label class="form-label small text-muted mb-1">Autor</label>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user text-muted me-2"></i>
                        <span class="badge bg-light text-dark border">{{ tutorial.autor.username }}</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="mb-3">
                    <label class="form-label small text-muted mb-1">Data de Criação</label>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-calendar-alt text-muted me-2"></i>
                        <span>{{ tutorial.data_criacao|local_datetime }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo do Tutorial -->
        <div class="mb-4">
            <label class="form-label small text-muted mb-2">Conteúdo</label>
            <div class="border rounded p-4 bg-light">
                <div class="markdown-content">{{ conteudo_markdown|safe }}</div>
            </div>
        </div>

        <!-- Imagens do Tutorial -->
        {% if tutorial.imagens %}
        <div class="mb-4">
            <label class="form-label small text-muted mb-2">Imagens</label>
            <div class="row g-3">
                {% for img in tutorial.imagens %}
                <div class="col-xl-4 col-lg-6 col-md-6">
                    <div class="card border-0">
                        <div class="card-body p-2 text-center">
                            <img src="{{ url_for('static', filename='uploads/' ~ img.filename) }}" 
                                 class="img-fluid rounded border" 
                                 alt="Imagem do tutorial"
                                 style="max-height: 200px; object-fit: contain;">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Card de Feedback -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-light border-0 py-3">
        <h6 class="mb-0 text-secondary"><i class="fas fa-star me-2"></i>Avaliação do Tutorial</h6>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('main.feedback_tutorial', tutorial_id=tutorial.id) }}">
            {{ feedback_form.hidden_tag() }}
            <div class="row g-3 align-items-end">
                <div class="col-lg-6">
                    <label class="form-label small text-muted mb-1">Este tutorial foi útil para você?</label>
                    <div class="d-flex align-items-center gap-3">
                        <div class="form-check">
                            {{ feedback_form.util(class="form-check-input", id="feedback_util") }}
                            <label class="form-check-label small text-muted" for="feedback_util">
                                Sim, foi útil
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-paper-plane me-1"></i>Enviar
                        </button>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="d-flex gap-3 justify-content-lg-end">
                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                            <i class="fas fa-thumbs-up me-1"></i>Útil: {{ tutorial.feedbacks|selectattr('util', 'equalto', True)|list|length }}
                        </span>
                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">
                            <i class="fas fa-thumbs-down me-1"></i>Não útil: {{ tutorial.feedbacks|selectattr('util', 'equalto', False)|list|length }}
                        </span>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Card de Comentários -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-light border-0 py-3">
        <h6 class="mb-0 text-secondary"><i class="fas fa-comments me-2"></i>Comentários e Dúvidas</h6>
    </div>
    <div class="card-body">
        {% if tutorial.comentarios %}
        <div class="list-group list-group-flush mb-4">
            {% for comentario in tutorial.comentarios %}
            <div class="list-group-item border-0 px-0 py-3">
                <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                    <div class="d-flex align-items-center">
                        <strong class="me-2">{{ comentario.usuario.username }}</strong>
                        <small class="text-muted">{{ comentario.data_criacao|local_datetime }}</small>
                    </div>
                </div>
                <p class="mb-0 text-dark">{{ comentario.texto }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-3 text-muted">
            <i class="fas fa-comment-slash fa-2x mb-2 d-block"></i>
            <p class="small mb-0">Nenhum comentário ainda.</p>
        </div>
        {% endif %}

        <!-- Formulário de Comentário -->
        <form method="POST" action="{{ url_for('main.comentar_tutorial', tutorial_id=tutorial.id) }}">
            {{ comentario_form.hidden_tag() }}
            <div class="mb-3">
                <label class="form-label small text-muted mb-1">Deixe sua dúvida ou comentário</label>
                {{ comentario_form.texto(class="form-control form-control-sm", rows=3, placeholder="Escreva seu comentário aqui...") }}
            </div>
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary btn-sm px-4">
                    <i class="fas fa-paper-plane me-1"></i>Comentar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Ações do Tutorial -->
{% if session.get('is_ti') and tutorial.autor_id == session.get('user_id') %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-light border-0 py-3">
        <h6 class="mb-0 text-secondary"><i class="fas fa-cogs me-2"></i>Ações do Tutorial</h6>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2 justify-content-end">
            <a href="{{ url_for('main.editar_tutorial', tutorial_id=tutorial.id) }}" class="btn btn-warning btn-sm">
                <i class="fas fa-edit me-1"></i>Editar
            </a>
            <form method="POST" action="{{ url_for('main.excluir_tutorial', tutorial_id=tutorial.id) }}" 
                  style="display:inline;" 
                  onsubmit="return confirm('Tem certeza que deseja excluir este tutorial?');">
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="fas fa-trash-alt me-1"></i>Excluir
                </button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
.markdown-content {
    line-height: 1.6;
}

.markdown-content h1, .markdown-content h2, .markdown-content h3 {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

.markdown-content p {
    margin-bottom: 1rem;
}

.markdown-content ul, .markdown-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.markdown-content code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}

.markdown-content pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    overflow-x: auto;
}

.markdown-content blockquote {
    border-left: 4px solid #dee2e6;
    padding-left: 1rem;
    margin-left: 0;
    color: #6c757d;
}
</style>

{% endblock %}
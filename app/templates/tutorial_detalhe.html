{% extends 'base.html' %}
{% block title %}{{ tutorial.titulo }} | Tutorial{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
      <div class="card">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h3 class="mb-0">{{ tutorial.titulo }}</h3>
          <a href="{{ url_for('main.exportar_tutorial_pdf', tutorial_id=tutorial.id) }}" class="btn btn-outline-light btn-sm"><i class="fas fa-file-pdf"></i> Exportar PDF</a>
        </div>
        <div class="card-body">
          <p class="mb-2"><strong>Categoria:</strong> {{ tutorial.categoria or 'Sem categoria' }}</p>
          <p class="mb-2"><strong>Autor:</strong> {{ tutorial.autor.username }}</p>
          <p class="mb-2"><strong>Data de criação:</strong> {{ tutorial.data_criacao|local_datetime }}</p>
          <hr>
          <div class="mb-3">
            <strong>Conteúdo:</strong>
            <div class="border rounded p-3 bg-light">{{ conteudo_markdown|safe }}</div>
          </div>
          {% if tutorial.imagens %}
          <div class="mb-3">
            <strong>Imagens:</strong>
            <div class="row">
              {% for img in tutorial.imagens %}
              <div class="col-6 col-md-4 mb-2">
                <img src="{{ url_for('static', filename='uploads/' ~ img.filename) }}" class="img-fluid rounded border" alt="Imagem do tutorial">
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          <hr>
          <div class="mb-3">
            <strong>Feedback:</strong>
            <form method="POST" action="{{ url_for('main.feedback_tutorial', tutorial_id=tutorial.id) }}">
              {{ feedback_form.hidden_tag() }}
              <div class="form-check form-check-inline">
                {{ feedback_form.util(class="form-check-input", id="feedback_util") }}
                <label class="form-check-label" for="feedback_util">Útil</label>
              </div>
              <button type="submit" class="btn btn-outline-success btn-sm ms-2">Enviar Feedback</button>
            </form>
            <div class="mt-2">
              <span class="badge bg-success">Útil: {{ tutorial.feedbacks|selectattr('util', 'equalto', True)|list|length }}</span>
              <span class="badge bg-danger">Não útil: {{ tutorial.feedbacks|selectattr('util', 'equalto', False)|list|length }}</span>
            </div>
          </div>
          <div class="mb-3">
            <strong>Comentários:</strong>
            <ul class="list-group mb-2">
              {% for comentario in tutorial.comentarios %}
              <li class="list-group-item">
                <div class="fw-bold">{{ comentario.usuario.username }} <span class="text-muted small">({{ comentario.data_criacao|local_datetime }})</span></div>
                <div>{{ comentario.texto }}</div>
              </li>
              {% else %}
              <li class="list-group-item text-muted">Nenhum comentário ainda.</li>
              {% endfor %}
            </ul>
            <form method="POST" action="{{ url_for('main.comentar_tutorial', tutorial_id=tutorial.id) }}">
              {{ comentario_form.hidden_tag() }}
              <div class="mb-2">
                {{ comentario_form.texto(class="form-control", rows=2, placeholder="Deixe sua dúvida ou comentário...") }}
              </div>
              <button type="submit" class="btn btn-outline-primary btn-sm">Comentar</button>
            </form>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
          <a href="{{ url_for('main.listar_tutoriais') }}" class="btn btn-outline-secondary">Voltar</a>
          {% if session.get('is_ti') and tutorial.autor_id == session.get('user_id') %}
          <div>
            <a href="{{ url_for('main.editar_tutorial', tutorial_id=tutorial.id) }}" class="btn btn-warning me-2">Editar</a>
            <form method="POST" action="{{ url_for('main.excluir_tutorial', tutorial_id=tutorial.id) }}" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir este tutorial?');">
              <button type="submit" class="btn btn-danger">Excluir</button>
            </form>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} 
{% extends "base.html" %}
{% block title %}Tickets & Suporte | TI OSN System{% endblock %}

{% block content %}
<style>
    .tickets-page .table thead th {
        position: sticky;
        top: 0;
        background-color: var(--bs-gray-100);
        z-index: 5;
    }

    [data-theme="dark"] .tickets-page .table thead th {
        background-color: var(--bs-gray-800);
        color: var(--bs-gray-100);
    }

    [data-theme="dark"] .tickets-page .card,
    [data-theme="dark"] .tickets-page .card-body,
    [data-theme="dark"] .tickets-page .card-header,
    [data-theme="dark"] .tickets-page .card-footer {
        background-color: var(--bs-gray-900) !important;
        border-color: rgba(255, 255, 255, 0.1) !important;
        color: var(--bs-gray-100);
    }

    [data-theme="dark"] .tickets-page .card-header.bg-light {
        background-color: var(--bs-gray-800) !important;
        color: var(--bs-gray-100);
    }

    [data-theme="dark"] .tickets-page .text-muted,
    [data-theme="dark"] .tickets-page .table td,
    [data-theme="dark"] .tickets-page .table th,
    [data-theme="dark"] .tickets-page label,
    [data-theme="dark"] .tickets-page small {
        color: var(--bs-gray-300) !important;
    }

    [data-theme="dark"] .tickets-page .table tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    [data-theme="dark"] .tickets-page .badge.bg-light {
        background-color: rgba(255, 255, 255, 0.1) !important;
        color: var(--bs-gray-100) !important;
        border-color: rgba(255, 255, 255, 0.15) !important;
    }

    [data-theme="dark"] .tickets-page .form-select,
    [data-theme="dark"] .tickets-page .form-control,
    [data-theme="dark"] .tickets-page .btn-outline-secondary {
        background-color: var(--bs-gray-900);
        border-color: var(--bs-gray-700);
        color: var(--bs-gray-100);
    }

    [data-theme="dark"] .tickets-page .btn-outline-secondary:hover {
        background-color: var(--bs-gray-800);
        color: var(--bs-gray-100);
    }

    [data-theme="dark"] .tickets-page .table th i,
    [data-theme="dark"] .tickets-page .card-header i {
        color: var(--bs-primary-light) !important;
    }

    [data-theme="dark"] .tickets-page .d-lg-none .card {
        background-color: var(--bs-gray-900);
        border-color: rgba(255,255,255,0.1);
        color: var(--bs-gray-100);
    }

    [data-theme="dark"] .tickets-page .pagination .page-link {
        background-color: var(--bs-gray-900);
        border-color: var(--bs-gray-700);
        color: var(--bs-gray-100);
    }

    [data-theme="dark"] .tickets-page .pagination .page-item.active .page-link {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
        color: #fff;
    }
</style>

<div class="tickets-page">

<!-- Header da Página -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="text-primary mb-0"><i class="fas fa-ticket-alt me-2"></i>Tickets & Suporte</h4>
    <a href="{{ url_for('main.abrir_chamado') }}" class="btn btn-success btn-sm">
        <i class="fas fa-plus-circle me-1"></i>Abrir Novo Ticket
    </a>
</div>

<!-- Card de Filtros -->
<div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-light border-0 py-3">
        <h6 class="mb-0 text-secondary"><i class="fas fa-filter me-2"></i>Filtros e Busca</h6>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('main.listar_chamados') }}" class="row g-3">
            <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label small text-muted mb-1">Status</label>
                <select name="status" id="status" class="form-select form-select-sm">
                    <option value="">Todos os status</option>
                    {% for s in status_list %}
                        <option value="{{ s }}" {% if request.args.get('status') == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label small text-muted mb-1">Prioridade</label>
                <select name="prioridade" id="prioridade" class="form-select form-select-sm">
                    <option value="">Todas as prioridades</option>
                    {% for p in prioridade_list %}
                        <option value="{{ p }}" {% if request.args.get('prioridade') == p %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if session.get('is_admin') %}
            <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label small text-muted mb-1">Setor</label>
                <select name="setor_id" id="setor_id" class="form-select form-select-sm">
                    <option value="">Todos os setores</option>
                    {% for setor in setores %}
                        <option value="{{ setor.id }}" {% if request.args.get('setor_id')|int == setor.id %}selected{% endif %}>{{ setor.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-xl-3 col-lg-6 col-md-6 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-filter me-1"></i>Filtrar
                </button>
            </div>
            <div class="col-xl-2 col-lg-6 col-md-6 d-flex align-items-end">
                <a href="{{ url_for('main.listar_chamados') }}" class="btn btn-outline-secondary btn-sm w-100">
                    <i class="fas fa-eraser me-1"></i>Limpar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Card de Lista de Chamados -->
<div class="card shadow-sm border-0">
    <div class="card-header bg-light border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 text-secondary"><i class="fas fa-list-check me-2"></i>Tickets Registrados</h6>
            <div class="badge bg-primary fs-6">
                {{ chamados|length }} ticket{{ 's' if chamados|length != 1 }}
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        
        <!-- Desktop View -->
        <div class="table-responsive d-none d-lg-block" style="max-height: 500px;">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light sticky-top">
                    <tr>
                        <th class="ps-3"><i class="fas fa-hashtag me-2 text-muted"></i>ID</th>
                        <th><i class="fas fa-heading me-2 text-muted"></i>Título</th>
                        <th class="text-center"><i class="fas fa-tag me-2 text-muted"></i>Status</th>
                        <th class="text-center"><i class="fas fa-exclamation-circle me-2 text-muted"></i>Prioridade</th>
                        <th class="text-center"><i class="fas fa-clock me-2 text-muted"></i>SLA</th>
                        <th><i class="fas fa-user me-2 text-muted"></i>Solicitante</th>
                        <th><i class="fas fa-sitemap me-2 text-muted"></i>Setor</th>
                        <th><i class="fas fa-calendar-alt me-2 text-muted"></i>Abertura</th>
                        <th class="text-center pe-3"><i class="fas fa-cogs me-2 text-muted"></i>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for chamado in chamados %}
                    <tr>
                        <td class="ps-3">
                            <span class="fw-bold text-muted">#{{ chamado.id }}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-ticket-alt text-muted me-2"></i>
                                <span class="text-truncate" style="max-width: 200px;" title="{{ chamado.titulo }}">
                                    {{ chamado.titulo }}
                                </span>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-{{ 'secondary' if chamado.status == 'Fechado' else ('success' if chamado.status == 'Resolvido' else ('warning' if chamado.status == 'Em Andamento' else 'primary')) }} bg-opacity-10 text-{{ 'secondary' if chamado.status == 'Fechado' else ('success' if chamado.status == 'Resolvido' else ('warning' if chamado.status == 'Em Andamento' else 'primary')) }} border border-{{ 'secondary' if chamado.status == 'Fechado' else ('success' if chamado.status == 'Resolvido' else ('warning' if chamado.status == 'Em Andamento' else 'primary')) }} border-opacity-25">
                                {{ chamado.status }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-{{ 'dark' if chamado.prioridade == 'Critica' else ('danger' if chamado.prioridade == 'Alta' else ('warning' if chamado.prioridade == 'Media' else 'info')) }} bg-opacity-10 text-{{ 'dark' if chamado.prioridade == 'Critica' else ('danger' if chamado.prioridade == 'Alta' else ('warning' if chamado.prioridade == 'Media' else 'info')) }} border border-{{ 'dark' if chamado.prioridade == 'Critica' else ('danger' if chamado.prioridade == 'Alta' else ('warning' if chamado.prioridade == 'Media' else 'info')) }} border-opacity-25">
                                {{ chamado.prioridade }}
                            </span>
                        </td>
                        <td class="text-center">
                            {% if chamado.prazo_sla %}
                                {% set status_sla = chamado.status_sla %}
                                {% if status_sla == 'cumprido' %}
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 d-inline-flex align-items-center gap-1">
                                        <i class="fas fa-check-circle"></i> Cumprido
                                    </span>
                                {% elif status_sla == 'vencido' %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 d-inline-flex align-items-center gap-1">
                                        <i class="fas fa-clock"></i> Vencido
                                    </span>
                                {% elif status_sla == 'atencao' %}
                                    <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 d-inline-flex align-items-center gap-1">
                                        <i class="fas fa-clock"></i> Atenção
                                    </span>
                                {% elif status_sla == 'normal' %}
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 d-inline-flex align-items-center gap-1">
                                        <i class="fas fa-check"></i> OK
                                    </span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ chamado.prazo_sla|local_datetime('%d/%m %H:%M') }}</small>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">
                                {{ chamado.solicitante.username if chamado.solicitante else 'N/A' }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">
                                {{ chamado.setor.name if chamado.setor else 'N/A' }}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">{{ chamado.data_abertura|local_datetime }}</small>
                        </td>
                        <td class="text-center pe-3">
                            <div class="d-flex gap-1 justify-content-center">
                                <a href="{{ url_for('main.detalhe_chamado', id=chamado.id) }}" class="btn btn-sm btn-outline-primary" title="Visualizar">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if chamado.solicitante_id == session.get('user_id') and chamado.status != 'Fechado' %}
                                <a href="{{ url_for('main.editar_chamado', id=chamado.id) }}" class="btn btn-sm btn-outline-warning" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                            Nenhum chamado encontrado
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile View -->
        <div class="d-lg-none">
            <div class="row g-3 p-3">
                {% for chamado in chamados %}
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="card-title mb-1">
                                        <span class="badge bg-light text-dark me-2">#{{ chamado.id }}</span>
                                        {{ chamado.titulo }}
                                    </h6>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-{{ 'secondary' if chamado.status == 'Fechado' else ('success' if chamado.status == 'Resolvido' else ('warning' if chamado.status == 'Em Andamento' else 'primary')) }} mb-1">{{ chamado.status }}</span>
                                    <br>
                                    <span class="badge bg-{{ 'dark' if chamado.prioridade == 'Critica' else ('danger' if chamado.prioridade == 'Alta' else ('warning' if chamado.prioridade == 'Media' else 'info')) }}">{{ chamado.prioridade }}</span>
                                </div>
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <small class="text-muted d-block">Solicitante</small>
                                    <span class="fw-medium">{{ chamado.solicitante.username if chamado.solicitante else 'N/A' }}</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Setor</small>
                                    <span class="fw-medium">{{ chamado.setor.name if chamado.setor else 'N/A' }}</span>
                                </div>
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <small class="text-muted d-block">Abertura</small>
                                    <span class="fw-medium">{{ chamado.data_abertura|local_datetime('%d/%m/%y %H:%M') }}</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">SLA</small>
                                    {% if chamado.prazo_sla %}
                                        {% set status_sla = chamado.status_sla %}
                                        {% if status_sla == 'cumprido' %}
                                            <span class="badge bg-success">
                                                <i class="fa fa-check"></i> Cumprido
                                            </span>
                                        {% elif status_sla == 'vencido' %}
                                            <span class="badge bg-danger">
                                                <i class="fa fa-clock"></i> Vencido
                                            </span>
                                        {% elif status_sla == 'atencao' %}
                                            <span class="badge bg-warning">
                                                <i class="fa fa-clock"></i> Atenção
                                            </span>
                                        {% elif status_sla == 'normal' %}
                                            <span class="badge bg-success">
                                                <i class="fa fa-check"></i> OK
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('main.detalhe_chamado', id=chamado.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i>Visualizar
                                </a>
                                {% if chamado.solicitante_id == session.get('user_id') and chamado.status != 'Fechado' %}
                                <a href="{{ url_for('main.editar_chamado', id=chamado.id) }}" class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-edit me-1"></i>Editar
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        Nenhum chamado encontrado
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Paginação -->
{% if pagination.pages > 1 %}
<div class="mt-4">
    <nav aria-label="Navegação de páginas">
        <ul class="pagination justify-content-center pagination-sm">
            {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('main.listar_chamados', page=pagination.prev_num, status=request.args.get('status', ''), prioridade=request.args.get('prioridade', ''), setor_id=request.args.get('setor_id', '')) }}">
                        <i class="fas fa-chevron-left me-1"></i>Anterior
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link"><i class="fas fa-chevron-left me-1"></i>Anterior</span>
                </li>
            {% endif %}
            
            {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                    {% if pagination.page == page_num %}
                        <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.listar_chamados', page=page_num, status=request.args.get('status', ''), prioridade=request.args.get('prioridade', ''), setor_id=request.args.get('setor_id', '')) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('main.listar_chamados', page=pagination.next_num, status=request.args.get('status', ''), prioridade=request.args.get('prioridade', ''), setor_id=request.args.get('setor_id', '')) }}">
                        Próxima<i class="fas fa-chevron-right ms-1"></i>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Próxima<i class="fas fa-chevron-right ms-1"></i></span>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}

{% endblock %}
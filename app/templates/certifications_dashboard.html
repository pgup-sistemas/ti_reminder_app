{% extends "base.html" %}

{% block title %}Certificações e Leaderboard - Sistema TI OSN{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-gradient-warning text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-trophy"></i> Certificações e Leaderboard da Comunidade
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-light btn-sm" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">

                    <!-- Estatísticas Gerais -->
                    <div class="row g-3 mb-4">
                        <div class="col-lg-3 col-md-6">
                            <div class="card card-service h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">Usuários Ativos</h6>
                                            <p class="text-muted small mb-0">Total de participantes</p>
                                        </div>
                                        <div class="bg-primary bg-opacity-10 p-2 rounded">
                                            <i class="fas fa-users text-primary"></i>
                                        </div>
                                    </div>
                                    <h3 class="text-primary mb-3">{{ cert_stats.total_users }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card card-service h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">Certificações Ativas</h6>
                                            <p class="text-muted small mb-0">Total concedidas</p>
                                        </div>
                                        <div class="bg-success bg-opacity-10 p-2 rounded">
                                            <i class="fas fa-certificate text-success"></i>
                                        </div>
                                    </div>
                                    <h3 class="text-success mb-3">{{ cert_stats.total_certifications }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card card-service h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">Taxa de Certificação</h6>
                                            <p class="text-muted small mb-0">Percentual de certificados</p>
                                        </div>
                                        <div class="bg-warning bg-opacity-10 p-2 rounded">
                                            <i class="fas fa-percentage text-warning"></i>
                                        </div>
                                    </div>
                                    <h3 class="text-warning mb-3">{{ "%.1f"|format(cert_stats.certification_rate) }}%</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card card-service h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="card-title mb-1">Contribuidores Rankeados</h6>
                                            <p class="text-muted small mb-0">No leaderboard</p>
                                        </div>
                                        <div class="bg-info bg-opacity-10 p-2 rounded">
                                            <i class="fas fa-medal text-info"></i>
                                        </div>
                                    </div>
                                    <h3 class="text-info mb-3">{{ leaderboard|length if leaderboard else 0 }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Métricas do Usuário Atual -->
                    {% if user_metrics %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-user"></i> Suas Métricas de Contribuição
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 text-center">
                                            <h3 class="text-primary">{{ user_metrics.total_points }}</h3>
                                            <p class="mb-0">Pontos Totais</p>
                                            <small class="text-muted">Atualizado em {{ user_metrics.last_updated.strftime('%d/%m/%Y') }}</small>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h3 class="text-success">{{ user_metrics.tutorials_created }}</h3>
                                            <p class="mb-0">Tutoriais Criados</p>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h3 class="text-info">{{ user_metrics.tutorial_views }}</h3>
                                            <p class="mb-0">Visualizações</p>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h3 class="text-warning">{{ user_metrics.helpful_votes }}</h3>
                                            <p class="mb-0">Votos Úteis</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="text-center">
                                        <span class="badge badge-lg badge-primary">
                                            Nível Atual: {{ user_metrics.get_certification_level()[1] }} - {{ user_metrics.get_certification_level()[0] }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Leaderboard -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">
                                        <i class="fas fa-crown"></i> Top Contribuidores
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% if leaderboard %}
                                        {% for contributor in leaderboard %}
                                        <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                                            <div class="flex-shrink-0 mr-3">
                                                {% if contributor.rank == 1 %}
                                                    <i class="fas fa-trophy text-warning fa-2x"></i>
                                                {% elif contributor.rank == 2 %}
                                                    <i class="fas fa-medal text-secondary fa-2x"></i>
                                                {% elif contributor.rank == 3 %}
                                                    <i class="fas fa-award text-danger fa-2x"></i>
                                                {% else %}
                                                    <span class="badge badge-lg badge-primary">{{ contributor.rank }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">{{ contributor.username }}</h6>
                                                <p class="mb-1 text-muted small">
                                                    {{ contributor.total_points }} pontos •
                                                    {{ contributor.tutorials_created }} tutoriais •
                                                    {{ contributor.helpful_votes }} votos úteis
                                                </p>
                                                <div>
                                                    <span class="badge badge-{{ 'primary' if contributor.certification_level >= 4 else 'success' if contributor.certification_level >= 3 else 'info' if contributor.certification_level >= 2 else 'secondary' }}">
                                                        Level {{ contributor.certification_level }} - {{ contributor.certification_type }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="flex-shrink-0">
                                                <div class="text-right">
                                                    <div class="h5 mb-0 text-primary">{{ contributor.total_points }}</div>
                                                    <small class="text-muted">pontos</small>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted text-center py-4">
                                            <i class="fas fa-users fa-2x mb-2"></i><br>
                                            Nenhum contribuidor rankeado ainda.
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Suas Certificações -->
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">
                                        <i class="fas fa-certificate"></i> Suas Certificações
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% if user_certs %}
                                        {% for cert in user_certs %}
                                        <div class="certification-item mb-3 p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">{{ cert.certification_type }}</h6>
                                                    <p class="mb-1 text-muted small">Nível {{ cert.level }}</p>
                                                    <small class="text-muted">
                                                        Concedida em {{ cert.awarded_at.strftime('%d/%m/%Y') }}
                                                    </small>
                                                </div>
                                                <div class="text-right">
                                                    {% if cert.is_active %}
                                                        <span class="badge badge-success">Ativa</span>
                                                    {% else %}
                                                        <span class="badge badge-secondary">Expirada</span>
                                                    {% endif %}
                                                    {% if cert.expires_at %}
                                                        <br><small class="text-muted">
                                                            {% if cert.is_active %}
                                                                Expira em {{ cert.expires_at.strftime('%d/%m/%Y') }}
                                                            {% else %}
                                                                Expirou em {{ cert.expires_at.strftime('%d/%m/%Y') }}
                                                            {% endif %}
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted text-center py-4">
                                            <i class="fas fa-certificate fa-2x mb-2"></i><br>
                                            Você ainda não possui certificações.<br>
                                            <small>Continue contribuindo para ganhar sua primeira certificação!</small>
                                        </p>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Como Ganhar Pontos -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-question-circle"></i> Como Ganhar Pontos
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled small">
                                        <li class="mb-2"><i class="fas fa-plus text-success"></i> <strong>10 pontos</strong> por tutorial criado</li>
                                        <li class="mb-2"><i class="fas fa-eye text-info"></i> <strong>0.1 ponto</strong> por visualização dos seus tutoriais</li>
                                        <li class="mb-2"><i class="fas fa-comment text-primary"></i> <strong>2 pontos</strong> por comentário feito</li>
                                        <li class="mb-2"><i class="fas fa-thumbs-up text-warning"></i> <strong>5 pontos</strong> por voto "útil" recebido</li>
                                    </ul>
                                    <hr>
                                    <div class="text-center">
                                        <small class="text-muted">
                                            Certificações são atualizadas automaticamente a cada hora.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Distribuição de Certificações -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Distribuição de Certificações</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="certificationsChart" width="800" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de distribuição de certificações
    const certCtx = document.getElementById('certificationsChart').getContext('2d');
    const certData = {{ cert_stats.certification_types|tojson }};
    const levelData = {{ cert_stats.certification_levels|tojson }};

    // Gráfico de tipos de certificação
    new Chart(certCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(certData),
            datasets: [{
                label: 'Certificações por Tipo',
                data: Object.values(certData),
                backgroundColor: [
                    '#007bff',
                    '#28a745',
                    '#ffc107',
                    '#dc3545',
                    '#17a2b8'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
});

function refreshData() {
    // Recarregar a página para atualizar dados
    location.reload();
}
</script>

<style>
.small-box {
    margin-bottom: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.certification-item {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.certification-item:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e7 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.badge-lg {
    font-size: 0.9em;
    padding: 0.5em 0.75em;
    border-radius: 6px;
}

.card-tools .btn {
    margin-left: 5px;
    border-radius: 6px;
}

.card {
    border-radius: 8px;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.card-header {
    border-radius: 8px 8px 0 0 !important;
    border: none;
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
}

.shadow-sm {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.text-primary { color: #007bff !important; }
.text-success { color: #28a745 !important; }
.text-info { color: #17a2b8 !important; }
.text-warning { color: #ffc107 !important; }
.text-danger { color: #dc3545 !important; }

.font-weight-bold {
    font-weight: 600 !important;
}

.d-flex {
    display: flex !important;
}

.align-items-center {
    align-items: center !important;
}

.flex-shrink-0 {
    flex-shrink: 0 !important;
}

.flex-grow-1 {
    flex-grow: 1 !important;
}

.mb-3 {
    margin-bottom: 1rem !important;
}

.pb-3 {
    padding-bottom: 1rem !important;
}

.border-bottom {
    border-bottom: 1px solid #dee2e6 !important;
}
</style>
{% endblock %}